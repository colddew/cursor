<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾Šäº†ä¸ªç¾Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #c0f473;
            --card-w: 66px;
            /* ç»§ç»­å¢å¤§ */
            --card-h: 80px;
            --card-radius: 14px;
            --footer-bg: #4c6828;
            --slot-bg: rgba(43, 61, 20, 0.9);
            --accent-color: #ffd700;
            --text-color: #2b3d14;
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            overflow: hidden;
            font-family: system-ui, -apple-system, sans-serif;
            user-select: none;
            touch-action: manipulation;
        }

        /* èƒŒæ™¯è‰ä¸›æ ·å¼ */
        .grass-bg {
            position: absolute;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .grass {
            position: absolute;
            width: 32px;
            height: 32px;
            fill: none;
            stroke: #2b3d14;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0.3;
            transition: transform 0.1s ease-out;
        }

        /* é»‘èƒ¶å”±ç‰‡éŸ³æ§ */
        #audio-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            /* å›å½’å³ä¾§ */
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 20000;
            /* æè‡´å±‚çº§ï¼Œç¡®ä¿é¦–é¡µé®ç½©ä¸‹ä¾ç„¶å¯ç‚¹ */
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 40px;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }

        .vinyl-record {
            width: 70px;
            height: 70px;
            background: #1a1a1a;
            border-radius: 50%;
            border: 4px solid #333;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            animation: rotate-vinyl 10s linear infinite paused;
            transition: filter 0.3s ease;
            overflow: hidden;
            /* å…³é”®ï¼šç¡®ä¿æ–œçº¿ä¸è¶…å‡ºé»‘èƒ¶ç›˜ */
        }

        .vinyl-record.playing {
            animation: rotate 3s linear infinite;
        }

        .vinyl-center {
            width: 20px;
            height: 20px;
            background: #ffd700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .music-note {
            font-size: 10px;
            animation: note-bounce 1.5s ease-in-out infinite;
        }

        @keyframes note-bounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        #volume-slider {
            width: 0;
            overflow: hidden;
            transition: width 0.3s;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            height: 6px;
            border-radius: 3px;
        }

        #audio-panel:hover #volume-slider {
            width: 100px;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
        }

        #game-stage {
            flex: 1;
            position: relative;
            width: 100%;
        }

        /* æ‹ŸçœŸå¡ç‰‡æ ·å¼ */
        .card {
            position: absolute;
            width: var(--card-w);
            height: var(--card-h);
            background: #fff;
            border: 2px solid #333;
            border-radius: var(--card-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            box-sizing: border-box;
            box-shadow: 0 4px 0 #888, 0 5px 10px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                left 0.3s ease-in-out,
                top 0.3s ease-in-out,
                filter 0.2s;
            z-index: 10;
        }

        /* ä¾§è¾¹åšåº¦æ„Ÿ */
        .card::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: -2px;
            right: -2px;
            height: 6px;
            background: #bbb;
            border: 2px solid #333;
            border-top: none;
            border-radius: 0 0 8px 8px;
            z-index: -1;
        }

        #audio-panel.muted .vinyl-record {
            filter: grayscale(1) contrast(0.5);
        }

        /* ä¼˜é›…å†…åœ†é™éŸ³çº¿ï¼š10:30 -> 4:30 (åæ–œæ  \) */
        #audio-panel.muted .vinyl-record::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 140%;
            height: 3px;
            background: rgba(230, 230, 230, 0.9);
            transform: translate(-50%, -50%) rotate(45deg);
            /* ä¿®æ­£æ–¹å‘è‡³åæ–œæ  */
            z-index: 20002;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .card.covered {
            filter: brightness(0.5) contrast(0.9);
            pointer-events: none;
        }

        .card.in-slot {
            box-shadow: none;
            pointer-events: none;
            transform: scale(0.9);
        }

        .card.in-slot::after {
            display: none;
        }

        /* æ¶ˆé™¤çˆ†è£‚ç‰¹æ•ˆ */
        .card.matching {
            animation: card-match-burst 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
            z-index: 1000 !important;
        }

        @keyframes card-match-burst {
            0% {
                transform: scale(1);
                filter: brightness(1) drop-shadow(0 0 0px gold);
            }

            50% {
                transform: scale(1.3);
                filter: brightness(2) drop-shadow(0 0 15px gold);
            }

            100% {
                transform: scale(0.5);
                opacity: 0;
                filter: brightness(3) drop-shadow(0 0 30px gold);
            }
        }

        /* æè‡´å½’ä½ï¼šæ˜Ÿå°˜æµæ²™ç²’å­ (å¸¦å…‰æ™•ï¼Œæ…¢é™) */
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 2000;
            box-shadow: 0 0 8px currentColor;
            /* å‘å…‰æ˜Ÿå°˜æ„Ÿ */
            mix-blend-mode: screen;
        }

        @keyframes stardust-drift {
            0% {
                transform: translate(0, 0) scale(1.5);
                opacity: 1;
                filter: brightness(2);
            }

            15% {
                transform: translate(calc(var(--tx) * 0.8), calc(var(--ty) * 0.8)) scale(1.2);
                opacity: 1;
            }

            100% {
                /* 2.5s çš„æ¼«é•¿è½¨è¿¹ï¼ŒåŠ å…¥é‡åŠ›ä¸‹å è¶‹åŠ¿ (++ty) */
                transform: translate(var(--tx), calc(var(--ty) + 150px)) scale(0);
                opacity: 0;
            }
        }

        #footer {
            height: 140px;
            background: linear-gradient(180deg, var(--footer-bg) 0%, #2a3b14 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 4px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 100;
        }

        #slot-container {
            width: 450px;
            /* å¢åŠ å®½åº¦ä»¥å®¹çº³ 7 å¼ å¤§å¡ç‰‡ */
            height: 94px;
            background: var(--slot-bg);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 2px;
            position: relative;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: transparent;
            /* ç§»é™¤é˜´å½±è’™ç‰ˆ */
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        #start-panel.overlay {
            background: transparent;
            z-index: 10001;
            /* ç›–è¿‡æ‰€æœ‰ */
        }

        /* é¦–é¡µéšè—åº•éƒ¨ footer å’Œé˜´å½± */
        body:has(#start-panel:not([style*="display: none"])) #footer {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #win-panel.overlay,
        #fail-panel.overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        /* æ‰«å…‰åŠ¨æ•ˆ */
        .shimmer {
            background: linear-gradient(90deg,
                    rgba(255, 215, 0, 0) 0%,
                    rgba(255, 215, 0, 0.8) 50%,
                    rgba(255, 215, 0, 0) 100%);
            background-size: 200% 100%;
            animation: shimmer 2.5s infinite linear;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            /* é‡è¦ï¼šè®©æ‰«å…‰é€å‡ºæ¥ */
        }

        @keyframes shimmer {
            0% {
                background-position: -100% 0;
            }

            100% {
                background-position: 100% 0;
            }
        }

        .btn {
            background: #ffcf44;
            color: #333;
            padding: 16px 60px;
            border-radius: 50px;
            font-weight: 1000;
            font-size: 1.4rem;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 6px 0 #d4a017;
            letter-spacing: 2px;
            position: relative;
            z-index: 10;
            /* å¾‹åŠ¨äº¤ç”± JS å¼•æ“é©±åŠ¨ï¼Œç§»é™¤ CSS å¼‚æ­¥åŠ¨ç”» */
        }

        .btn:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15), 0 6px 0 #d4a017;
        }

        .btn:active {
            transform: scale(0.92);
            box-shadow: 0 2px 0 #d4a017;
        }

        @keyframes ear-flutter {

            0%,
            100% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(-8deg);
            }
        }

        .ear-group {
            transform-origin: 30% 20%;
            animation: ear-flutter 2s infinite ease-in-out;
        }

        .ear-group-right {
            transform-origin: 70% 20%;
            animation: ear-flutter 2.2s infinite ease-in-out reverse;
        }

        /* è¿è¡Œä¸­çš„å°ç¾Š */
        .sheep-circle {
            position: relative;
            width: 300px;
            height: 300px;
            margin-bottom: 2rem;
        }

        .running-sheep {
            display: none;
        }

        .sheep-svg {
            position: absolute;
            width: 90px;
            height: 90px;
            /* é¡ºæ—¶é’ˆè·¯å¾„ */
            offset-path: path('M 150, 150 m -100, 0 a 100,100 0 1,1 200,0 a 100,100 0 1,1 -200,0');
            offset-rotate: auto 180deg;
            animation: move-around 10s linear infinite;
            /* åŠ å¿«ä¸€ä¸¢ä¸¢ */
        }

        /* ç¾Šç¾¤å‘¼å¸ä¸ç¼©æ”¾å¾®åŠ¨ */
        .sheep-pulse {
            animation: pulse-mini 0.8s ease-in-out infinite alternate;
            transform-origin: center bottom;
        }

        @keyframes pulse-mini {
            from {
                transform: scale(0.98);
            }

            to {
                transform: scale(1.02);
            }
        }

        .sheep-shadow {
            position: absolute;
            width: 80px;
            height: 20px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 50%;
            bottom: 12px;
            /* è´´åˆè¹„éƒ¨ */
            left: 20px;
            filter: blur(3px);
            z-index: -1;
            animation: pulse-mini 2s infinite ease-in-out;
        }

        .leg {
            transform-origin: top;
            transform-box: fill-box;
            animation: leg-swing 0.3s ease-in-out infinite alternate;
        }

        .leg-back {
            animation-delay: -0.2s;
        }

        @keyframes leg-swing {
            0% {
                transform: rotate(-15deg);
            }

            100% {
                transform: rotate(15deg);
            }
        }

        @keyframes move-around {
            0% {
                offset-distance: 0%;
            }

            100% {
                offset-distance: 100%;
            }
        }
    </style>
</head>

<body>
    <svg style="display: none;">
        <symbol id="sheep-def" viewBox="-10 -10 150 130">
            <g class="sheep-body-group sheep-pulse">
                <!-- æ˜¾åŒ–é•¿è…¿ï¼šèµ·ç‚¹æ›´é«˜ (y=28)ï¼Œé•¿åº¦å»¶ä¼¸è‡³ 38px -->
                <rect class="leg" x="48" y="28" width="13" height="38" rx="5" fill="#1a1a1a" />
                <rect class="leg leg-back" x="65" y="30" width="13" height="38" rx="5" fill="#1a1a1a" />
                <rect class="leg" x="80" y="30" width="13" height="38" rx="5" fill="#1a1a1a" />
                <rect class="leg leg-back" x="93" y="28" width="13" height="38" rx="5" fill="#1a1a1a" />

                <!-- â€œçº¸ç‰‡çº§â€å‰ªå½±èº«ä½“ (y=35)ï¼Œæè‡´ææ‹‰æ”¶è…¹ -->
                <path
                    d="M50 25 A18 18 0 0 1 75 12 A22 22 0 0 1 110 28 A18 18 0 0 1 123 35 A20 20 0 0 1 100 35 A25 25 0 0 1 45 35 A18 18 0 0 1 12 32 A20 20 0 0 1 50 25"
                    fill="#fff" stroke="#1a1a1a" stroke-width="3.2" />

                <!-- å¤´éƒ¨ï¼šé”¥å½¢çµåŠ¨ç˜¦è€³ï¼ˆæ ¹éƒ¨ç»†ã€å°–ç«¯åœ†ï¼‰ -->
                <g transform="translate(10, 15)">
                    <ellipse cx="25" cy="22" rx="22" ry="19" fill="#333" stroke="#1a1a1a" stroke-width="3" />
                    <g class="ear-group">
                        <path d="M5 8 Q-5 0 -12 10 Q-15 18 -6 18 L2 14" fill="#222" stroke="#1a1a1a"
                            stroke-width="2.2" />
                    </g>
                    <g class="ear-group-right">
                        <path d="M45 8 Q55 0 62 10 Q65 18 56 18 L48 14" fill="#222" stroke="#1a1a1a"
                            stroke-width="2.2" />
                    </g>
                    <!-- é¢éƒ¨ -->
                    <circle cx="16" cy="15" r="9.5" fill="white" stroke="#1a1a1a" stroke-width="2" />
                    <circle cx="34" cy="15" r="9.5" fill="white" stroke="#1a1a1a" stroke-width="2" />
                    <circle cx="18" cy="12" r="3.5" fill="#1a1a1a" />
                    <circle cx="36" cy="12" r="3.5" fill="#1a1a1a" />
                    <path d="M21 32 Q25 35 29 32" stroke="#1a1a1a" fill="none" stroke-width="2.5"
                        stroke-linecap="round" />
                </g>
            </g>
        </symbol>
    </svg>

    <div id="audio-panel">
        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.7" oninput="setVolume(this.value)">
        <div id="music-btn" class="vinyl-record" onclick="toggleMusic()">
            <div class="vinyl-center">
                <span class="music-note" style="color: #1a260d;">â™«</span>
            </div>
        </div>
    </div>

    <div id="game-container">
        <div class="grass-bg" id="grass-bg"></div>
        <div id="game-stage"></div>
        <div id="footer">
            <div id="slot-container"></div>
        </div>
    </div>

    <div id="start-panel" class="overlay">
        <div class="sheep-circle">
            <!-- å½±åˆ†èº«è·‘åŠ¨ï¼šç´§å‡‘æ’åˆ—ï¼Œå®ç°è¿½éšæ„Ÿ -->
            <!-- ç²¾å¯†å‘¼å¸é˜Ÿå½¢ï¼šæ­¥é•¿ -0.95sï¼Œå®ç°â€œå†é è¿‘ä¸€ä¸¢ä¸¢â€çš„é«˜çº§æ„Ÿ -->
            <div class="sheep-svg" style="animation-delay: 0s; z-index: 40;">
                <div class="sheep-shadow"></div><svg viewBox="-10 -10 150 130">
                    <use href="#sheep-def" />
                </svg>
            </div>
            <div class="sheep-svg" style="animation-delay: -0.95s; z-index: 30;">
                <div class="sheep-shadow"></div><svg viewBox="-10 -10 150 130">
                    <use href="#sheep-def" />
                </svg>
            </div>
            <div class="sheep-svg" style="animation-delay: -1.9s; z-index: 20;">
                <div class="sheep-shadow"></div><svg viewBox="-10 -10 150 130">
                    <use href="#sheep-def" />
                </svg>
            </div>
            <div class="sheep-svg" style="animation-delay: -2.85s; z-index: 10;">
                <div class="sheep-shadow"></div><svg viewBox="-10 -10 150 130">
                    <use href="#sheep-def" />
                </svg>
            </div>
        </div>
        <div id="title-wrapper" style="transition: transform 0.05s ease-out;">
            <h1 class="text-8xl font-black mb-6 italic"
                style="background: linear-gradient(180deg, #fff2ac 0%, #d4a017 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.4));">
                ç¾Šäº†ä¸ªç¾Š</h1>
        </div>
        <div id="slogan-wrapper" class="relative mb-10 pb-4" style="transition: transform 0.05s ease-out;">
            <p class="text-2xl font-bold tracking-widest"
                style="color: rgba(76, 104, 40, 0.7); text-shadow: 1px 1px 0 rgba(255,255,255,0.3);">æ¯å¤©ä¸€æ¬¡åŠ¨æ¬¡æ‰“æ¬¡</p>
            <p class="text-2xl font-bold tracking-widest absolute inset-0 shimmer"
                style="color: transparent; -webkit-background-clip: text; background-clip: text;">æ¯å¤©ä¸€æ¬¡åŠ¨æ¬¡æ‰“æ¬¡</p>
        </div>
        <div id="btn-wrapper" style="transition: transform 0.05s ease-out;">
            <div class="btn transform transition hover:scale-110 shadow-2xl" id="start-btn" onclick="startGame()"
                style="background: linear-gradient(180deg, #ffcf44 0%, #f7d047 100%); color: #2b3d14;">ä¸ æœ æ¥ æˆ˜</div>
        </div>
    </div>

    <div id="win-panel" class="overlay" style="display:none">
        <div class="text-6xl mb-4">ğŸ‘‘</div>
        <h1 class="text-3xl font-bold">é€šå…³ç¬¬ä¸€å…³ï¼</h1>
        <p class="mt-2 text-yellow-400">ç¬¬äºŒå…³æ‰æ˜¯å™©æ¢¦çš„å¼€å§‹...</p>
        <div class="btn" onclick="startLevel2()">æŒ‘æˆ˜ç¬¬äºŒå…³</div>
    </div>

    <div id="fail-panel" class="overlay" style="display:none">
        <div class="text-6xl mb-4">ğŸ–</div>
        <h1 class="text-3xl font-bold">æ§½ä½æ»¡äº†ï¼</h1>
        <p class="mt-2">ä½ æˆäº†éš”å£è€ç‹çš„ç›˜ä¸­é¤</p>
        <div class="btn" onclick="resetGameToLevel1()">ä¸æœå†æˆ˜</div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let bgmSource, analyser, dataArray, gainNode;
        let bgmElement; // Streaming element
        const BGM_URL = 'https://cdn.jsdelivr.net/gh/colddew/cursor@main/mini-games/sheep.MP3';

        let isMutedManually = false;

        async function initAudio() {
            try {
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                if (isMutedManually) return;

                if (!bgmElement) {
                    // å½»åº•ä¼˜åŒ–ï¼šä½¿ç”¨ HTML5 Audio Streaming æ¥å…¥ Web Audio API
                    // ä¼˜åŠ¿ï¼šè¾¹ä¸‹è¾¹æ”¾ï¼Œç¬é—´å“èµ·ï¼Œå®Œå…¨ä¸å¡ä¸»çº¿ç¨‹
                    bgmElement = new Audio();
                    bgmElement.src = BGM_URL;
                    bgmElement.crossOrigin = "anonymous";
                    bgmElement.loop = true;

                    bgmSource = audioCtx.createMediaElementSource(bgmElement);
                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 256;
                    dataArray = new Uint8Array(analyser.frequencyBinCount);

                    gainNode = audioCtx.createGain();
                    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);

                    bgmSource.connect(analyser);
                    analyser.connect(gainNode);
                    gainNode.connect(audioCtx.destination);

                    bgmElement.play().then(() => {
                        document.getElementById('music-btn').classList.add('playing');
                    }).catch(e => console.warn("Auto-play blocked, waiting for interaction"));
                } else if (bgmElement.paused) {
                    bgmElement.play();
                    document.getElementById('music-btn').classList.add('playing');
                }
            } catch (e) {
                console.warn('Audio streaming init failed:', e);
            }
        }


        function toggleMusic() {
            const panel = document.getElementById('audio-panel');
            if (!bgmElement) {
                isMutedManually = false;
                initAudio();
                panel.classList.remove('muted');
                return;
            }
            if (!bgmElement.paused) {
                bgmElement.pause();
                isMutedManually = true;
                document.getElementById('music-btn').classList.remove('playing');
                panel.classList.add('muted');
            } else {
                audioCtx.resume();
                bgmElement.play();
                isMutedManually = false;
                document.getElementById('music-btn').classList.add('playing');
                panel.classList.remove('muted');
            }
        }
        // é»˜è®¤å°è¯•æ¢å¤ç¯å¢ƒ
        window.addEventListener('mousedown', () => { if (audioCtx.state === 'suspended') initAudio(); }, { once: true });
        window.addEventListener('touchstart', () => { if (audioCtx.state === 'suspended') initAudio(); }, { once: true });

        function setVolume(val) {
            if (gainNode) {
                gainNode.gain.setTargetAtTime(val, audioCtx.currentTime, 0.1);
            }
        }

        function playSound(type) {
            if (isMutedManually) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;

            if (type === 'match') {
                // é£˜æ¸ºé£é“ƒ (Ethereal Wind Chime Flutter): æ¨¡æ‹Ÿé£æ‹‚è¿‡é‡‘å±/ç»ç’ƒé£é“ƒçš„ç²¾çµæ„Ÿ
                const masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                masterGain.gain.setValueAtTime(0, now);
                masterGain.gain.linearRampToValueAtTime(0.8, now + 0.01);
                masterGain.gain.exponentialRampToValueAtTime(0.001, now + 2.5);

                const filter = audioCtx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.setValueAtTime(1000, now);
                filter.connect(masterGain);

                const scale = [1318.51, 1567.98, 1760.00, 1975.53, 2349.32, 2637.02];
                for (let i = 0; i < 10; i++) {
                    const d = Math.random() * 0.4;
                    const f = scale[Math.floor(Math.random() * scale.length)];

                    // 1. å†²å‡»å±‚ (The Strike)
                    const oscS = audioCtx.createOscillator();
                    const modS = audioCtx.createOscillator();
                    const mgS = audioCtx.createGain();
                    const envS = audioCtx.createGain();
                    oscS.frequency.setValueAtTime(f, now + d);
                    modS.frequency.setValueAtTime(f * 1.5, now + d);
                    mgS.gain.setValueAtTime(f * 0.4, now + d);
                    mgS.gain.exponentialRampToValueAtTime(0.01, now + d + 0.1);
                    envS.gain.setValueAtTime(0, now + d);
                    envS.gain.linearRampToValueAtTime(0.3, now + d + 0.005);
                    envS.gain.exponentialRampToValueAtTime(0.001, now + d + 0.12);
                    modS.connect(mgS); mgS.connect(oscS.frequency);
                    oscS.connect(envS); envS.connect(filter);

                    // 2. å…±æŒ¯å±‚ (The Resonance)
                    const oscR = audioCtx.createOscillator();
                    const envR = audioCtx.createGain();
                    oscR.frequency.setValueAtTime(f, now + d);
                    envR.gain.setValueAtTime(0, now + d);
                    envR.gain.linearRampToValueAtTime(0.15, now + d + 0.05);
                    envR.gain.exponentialRampToValueAtTime(0.001, now + d + 2.0);
                    oscR.connect(envR); envR.connect(filter);

                    oscS.start(now + d); modS.start(now + d); oscR.start(now + d);
                    oscS.stop(now + d + 0.2); modS.stop(now + d + 0.2); oscR.stop(now + d + 2.2);
                }
                // å¾®å…‰é—ªçƒ (Elven Shimmer)
                for (let j = 0; j < 6; j++) {
                    const d = Math.random() * 0.8;
                    const f = 8000 + Math.random() * 4000;
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.frequency.setValueAtTime(f, now + d);
                    g.gain.setValueAtTime(0, now + d);
                    g.gain.linearRampToValueAtTime(0.04, now + d + 0.01);
                    g.gain.exponentialRampToValueAtTime(0.001, now + d + 0.15);
                    o.connect(g); g.connect(masterGain);
                    o.start(now + d); o.stop(now + d + 0.2);
                }
            } else if (type === 'fail') {
                // è¡å’Œä¸§çš„å¤±è½é•¿éŸ³ (Swinging Sinking Fail): Vibrato Sawtooth
                const dur = 1.6;
                const mg = audioCtx.createGain();
                mg.connect(audioCtx.destination);
                mg.gain.setValueAtTime(0.5, now);
                mg.gain.exponentialRampToValueAtTime(0.001, now + dur);

                const osc = audioCtx.createOscillator();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(380, now);
                osc.frequency.exponentialRampToValueAtTime(45, now + dur);

                // LFO äº§ç”Ÿçš„â€œè¡â€æ„Ÿ (Vibrato)
                const lfo = audioCtx.createOscillator();
                const lg = audioCtx.createGain();
                lfo.frequency.setValueAtTime(6, now); // 6Hz é¢¤æŠ–
                lg.gain.setValueAtTime(20, now); // 20Hz çš„é¢‘åå˜åŒ–
                lfo.connect(lg);
                lg.connect(osc.frequency);

                osc.connect(mg);
                lfo.start(now); osc.start(now);
                lfo.stop(now + dur); osc.stop(now + dur);
            } else if (type === 'click') {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                g.gain.setValueAtTime(0.3, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.connect(g);
                g.connect(audioCtx.destination);
                osc.start(); osc.stop(now + 0.1);
            }
        }

        function initGrass() {
            const container = document.getElementById('grass-bg');
            container.innerHTML = '';
            const types = [
                `<path d="M5 25 Q10 10 15 25 Q20 10 25 25" />`, // m
                `<path d="M2 25 Q7 5 12 25 Q17 5 22 25 Q27 5 32 25" />`, // triple m
                `<path d="M10 25 L15 15 L20 25" stroke-opacity="0.5" />` // rare v/^
            ];
            for (let i = 0; i < 35; i++) {
                const grass = document.createElement('div');
                grass.className = 'grass';
                grass.style.left = Math.random() * 95 + '%';
                grass.style.top = Math.random() * 95 + '%';
                grass.innerHTML = `<svg viewBox="0 0 35 30">${types[Math.floor(Math.random() * types.length)]}</svg>`;
                container.appendChild(grass);
            }
        }

        function animateGrass() {
            requestAnimationFrame(animateGrass);

            let ratio = 0;
            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                const bassRange = 8;
                for (let i = 0; i < bassRange; i++) sum += dataArray[i];
                const avg = sum / bassRange;
                ratio = avg / 255;
            } else {
                // é™é»˜æ´»åŠ›ç®—æ³•ï¼šå½“éŸ³ä¹æœªåŠ è½½æˆ–é™éŸ³æ—¶ï¼Œæä¾›åŸºç¡€çš„æ…¢èŠ‚å¥å‘¼å¸
                ratio = (Math.sin(Date.now() / 1500) + 1) * 0.05;
            }

            const bounce = ratio * 45;
            const scale = 1 + ratio * 0.18;
            const btnScale = 1 + ratio * 0.35;

            // UI å®æ—¶å¾‹åŠ¨
            const title = document.getElementById('title-wrapper');
            const slogan = document.getElementById('slogan-wrapper');
            const btn = document.getElementById('btn-wrapper');
            if (title) title.style.transform = `scale(${scale})`;
            if (slogan) slogan.style.transform = `scale(${1 + ratio * 0.15})`;
            if (btn) btn.style.transform = `scale(${btnScale})`;

            document.querySelectorAll('.grass').forEach((g, idx) => {
                const shift = Math.sin(Date.now() / 250 + idx) * 6;
                g.style.transform = `translateY(${-bounce}px) rotate(${shift}deg)`;
                // å³ä½¿é™é»˜ä¹Ÿæœ‰åŸºç¡€é€æ˜åº¦
                g.style.opacity = 0.3 + ratio * 0.7;
            });
        }

        const ICONS = ['ğŸ', 'ğŸ“', 'ğŸ¥•', 'ğŸŒ½', 'ğŸ‡', 'ğŸ„', 'ğŸŒ³', 'ğŸ§¶', 'ğŸ””', 'ğŸ¥›', 'ğŸ”¥', 'ğŸ§±', 'ğŸ¥¦', 'ğŸ‰', 'ğŸ¥¨', 'ğŸ°'];
        let allCards = [];
        let slotCards = [];
        let currentLevel = 1;
        let gameState = 'playing'; // 'playing', 'won', 'lost'

        const stage = document.getElementById('game-stage');
        const slotContainer = document.getElementById('slot-container');

        window.onload = () => {
            initGrass();
            animateGrass(); // å¯åŠ¨è§†è§‰å¾ªç¯
        };

        function startGame() {
            document.getElementById('start-panel').style.display = 'none';
            setTimeout(initAudio, 50); // å¾®å»¶åï¼Œç¡®ä¿é¢æ¿åˆ‡æ¢æµç•…
            initLevel(1);
        }

        function initLevel(level) {
            currentLevel = level;
            stage.innerHTML = '';
            allCards = [];
            slotCards = [];
            gameState = 'playing';
            updateSlotUI();

            const stageW = stage.clientWidth;
            const stageH = stage.clientHeight;
            const cx = stageW / 2;
            const cy = stageH / 2;

            if (level === 1) {
                // ç¬¬ä¸€å…³ï¼šå¡ç‰‡æ›´å¤§ï¼Œé—´è·æ‹‰å®½ï¼Œè§†è§‰æ›´èˆ’é€‚
                const pool = [ICONS[0], ICONS[1], ICONS[2]];
                let deck = [];
                pool.forEach(icon => deck.push(icon, icon, icon));
                deck.sort(() => Math.random() - 0.5);

                deck.forEach((icon, i) => {
                    // é—´è·æ‹‰å¤§ï¼šåŸ 55->95, åŸ 70->100
                    const x = cx - 120 + (i % 3) * 95;
                    const y = cy - 130 + Math.floor(i / 3) * 100;
                    createCard(icon, x, y, i);
                });
            } else {
                // ç¬¬äºŒå…³ç®—æ³•é‡æ„ï¼šä¸»è¦é›†ä¸­åœ¨ä¸­é—´ 1/3ï¼Œå¯†åº¦å‡å°ï¼Œä¸¥æ ¼æ§åˆ¶ä¾§ç¿¼
                const poolSize = ICONS.length;
                const totalGroups = 28; // å‡å°‘æ€»æ•°è‡³ 84 å¼ ï¼Œè¿½æ±‚ç²¾ç¾æ„Ÿ
                let deck = [];
                for (let i = 0; i < totalGroups; i++) {
                    const icon = ICONS[i % poolSize];
                    deck.push(icon, icon, icon);
                }
                deck.sort(() => Math.random() - 0.5);

                deck.forEach((icon, i) => {
                    // 75% æ¦‚ç‡é›†ä¸­åœ¨ä¸­é—´ 1/3 (35%-65%)
                    let x;
                    if (Math.random() < 0.75) {
                        x = stageW * 0.35 + Math.random() * (stageW * 0.3) - 33;
                    } else {
                        // 25% æ¦‚ç‡ç¨å¾®å‘ä¸¤ä¾§åç§»ï¼Œä½†ä¸¥æ ¼é¿å¼€è¾¹ç¼˜
                        x = stageW * 0.22 + Math.random() * (stageW * 0.56) - 33;
                    }

                    const y = 80 + Math.random() * (stageH - 260);
                    createCard(icon, x, y, i);
                });
            }
            checkCover();
        }

        function createCard(icon, x, y, z) {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = icon;
            div.style.left = `${x}px`;
            div.style.top = `${y}px`;
            div.style.zIndex = z;

            const cardObj = { el: div, icon, x, y, z, state: 'stage' };
            div.onclick = () => onCardClick(cardObj);
            stage.appendChild(div);
            allCards.push(cardObj);
        }

        function onCardClick(card) {
            if (gameState !== 'playing') return;
            if (card.state !== 'stage' || card.el.classList.contains('covered')) return;
            if (slotCards.length >= 7) return;

            playSound('click');
            card.state = 'slot';
            card.el.classList.add('in-slot');

            // æŸ¥æ‰¾ç›¸åŒå›¾æ ‡çš„ä½ç½® (æ‰‹åŠ¨æŸ¥æ‰¾ä»¥ä¿è¯å…¼å®¹æ€§)
            let lastIdx = -1;
            for (let i = slotCards.length - 1; i >= 0; i--) {
                if (slotCards[i].icon === card.icon) {
                    lastIdx = i;
                    break;
                }
            }
            const targetIdx = lastIdx === -1 ? slotCards.length : lastIdx + 1;
            slotCards.splice(targetIdx, 0, card);

            updateSlotUI();
            checkCover();

            // æ£€æŸ¥æ¶ˆé™¤
            const sameIcons = slotCards.filter(c => c.icon === card.icon);
            if (sameIcons.length === 3) {
                playSound('match');
                const matchTriple = sameIcons;
                matchTriple.forEach(c => {
                    const rect = c.el.getBoundingClientRect();
                    createFirework(rect.left + rect.width / 2, rect.top + rect.height / 2);
                    c.el.classList.add('matching');
                });

                setTimeout(() => {
                    matchTriple.forEach(c => {
                        if (c.el.parentNode) c.el.parentNode.removeChild(c.el);
                        const idx = slotCards.indexOf(c);
                        if (idx > -1) slotCards.splice(idx, 1);
                        // ç¡®ä¿ä» allCards ä¸­ä¹Ÿå½»åº•ç§»é™¤ï¼Œé˜²æ­¢é€»è¾‘æ®‹ç•™
                        const aIdx = allCards.indexOf(c);
                        if (aIdx > -1) allCards.splice(aIdx, 1);
                    });
                    slotCards = slotCards.filter(c => !matchTriple.includes(c));
                    allCards = allCards.filter(c => !matchTriple.includes(c));
                    updateSlotUI();
                    checkWin();
                }, 350);
                return;
            } else if (slotCards.length >= 7) {
                gameState = 'lost';
                playSound('fail');
                setTimeout(() => {
                    document.getElementById('fail-panel').style.display = 'flex';
                }, 400);
            }
        }

        function checkWin() {
            if (allCards.length === 0) {
                gameState = 'won';
                if (currentLevel === 1) {
                    document.getElementById('win-panel').style.display = 'flex';
                } else {
                    alert("ğŸ‰ å¥‡è¿¹ï¼ä½ é€šè¿‡äº†ç¬¬äºŒå…³ï¼");
                }
            }
        }

        function updateSlotUI() {
            slotCards.forEach((card, i) => {
                if (card.el.parentNode !== slotContainer) {
                    slotContainer.appendChild(card.el);
                }

                card.el.style.zIndex = 1000 + i;
                const targetX = 14 + i * 61;
                const targetY = 8;

                card.el.style.left = `${targetX}px`;
                card.el.style.top = `${targetY}px`;
            });
        }

        function checkCover() {
            allCards.forEach(c1 => {
                if (c1.state !== 'stage') return;
                let isCovered = false;
                for (let c2 of allCards) {
                    if (c2.state === 'stage' && c2.z > c1.z) {
                        // åˆ¤å®šè°ƒæ•´ä»¥é€‚åº”å¤§å¡ç‰‡ï¼šå¢å¤§é‡å åˆ¤å®šé˜ˆå€¼
                        const overlapX = Math.abs(c1.x - c2.x) < 58;
                        const overlapY = Math.abs(c1.y - c2.y) < 70;
                        if (overlapX && overlapY) {
                            isCovered = true;
                            break;
                        }
                    }
                }
                c1.el.classList.toggle('covered', isCovered);
            });
        }

        function startLevel2() {
            document.getElementById('win-panel').style.display = 'none';
            initLevel(2);
        }

        function createFirework(x, y) {
            const colors = ['#FFD700', '#FF4500', '#00FA9A', '#1E90FF', '#FF1493', '#FFFFFF', '#ADFF2F'];
            const container = document.body;

            for (let i = 0; i < 24; i++) { // å¢åŠ ç²’å­é‡ï¼Œæ›´æ˜¾éœ‡æ’¼
                const p = document.createElement('div');
                p.className = 'particle';
                const size = 5 + Math.random() * 5;
                p.style.width = size + 'px';
                p.style.height = size + 'px';
                const color = colors[Math.floor(Math.random() * colors.length)];
                p.style.backgroundColor = color;
                p.style.color = color; // box-shadow ä½¿ç”¨ currentColor
                p.style.left = x + 'px';
                p.style.top = y + 'px';

                const angle = Math.random() * Math.PI * 2;
                const velocity = 10 + Math.random() * 20;
                // æ˜¾è‘—æ‹‰å¤§æ‰©æ•£åŠå¾„
                const tx = Math.cos(angle) * velocity * 25;
                const ty = Math.sin(angle) * velocity * 25;

                p.style.setProperty('--tx', `${tx}px`);
                p.style.setProperty('--ty', `${ty}px`);
                // åŠ¨ç”»æ—¶é•¿æ‹‰é•¿è‡³ 2.5sï¼Œå‘ˆç°ä¼˜é›…æ…¢å 
                p.style.animation = `stardust-drift 2.5s cubic-bezier(0.1, 0.8, 0.2, 1) forwards`;

                container.appendChild(p);
                setTimeout(() => p.remove(), 2500);
            }
        }

        function resetGameToLevel1() {
            gameState = 'playing';
            document.getElementById('fail-panel').style.display = 'none';
            document.getElementById('win-panel').style.display = 'none';
            slotCards = [];
            slotContainer.innerHTML = ''; // ä¿®å¤ï¼šé‡ç½®æ—¶æ¸…ç©ºæ§½ä½ UI
            initLevel(1);
        }
    </script>
</body>

</html>