<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾Šäº†ä¸ªç¾Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #c0f473;
            --card-w: 66px;
            /* ç»§ç»­å¢å¤§ */
            --card-h: 80px;
            --card-radius: 14px;
            --footer-bg: #4c6828;
            --slot-bg: rgba(43, 61, 20, 0.9);
            --accent-color: #ffd700;
            --text-color: #2b3d14;
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            overflow: hidden;
            font-family: system-ui, -apple-system, sans-serif;
            user-select: none;
            touch-action: manipulation;
        }

        /* èƒŒæ™¯è‰ä¸›æ ·å¼ */
        .grass-bg {
            position: absolute;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .grass {
            position: absolute;
            width: 32px;
            height: 32px;
            fill: none;
            stroke: #2b3d14;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0.3;
            transition: transform 0.1s ease-out;
        }

        /* é»‘èƒ¶å”±ç‰‡éŸ³æ§ */
        #audio-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            /* å›å½’å³ä¾§ */
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 20000;
            /* æè‡´å±‚çº§ï¼Œç¡®ä¿é¦–é¡µé®ç½©ä¸‹ä¾ç„¶å¯ç‚¹ */
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 40px;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }

        .vinyl-record {
            width: 70px;
            height: 70px;
            background: #1a1a1a;
            border-radius: 50%;
            border: 4px solid #333;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            animation: rotate-vinyl 10s linear infinite paused;
            transition: filter 0.3s ease;
            overflow: hidden;
            /* å…³é”®ï¼šç¡®ä¿æ–œçº¿ä¸è¶…å‡ºé»‘èƒ¶ç›˜ */
        }

        .vinyl-record.playing {
            animation: rotate 3s linear infinite;
        }

        .vinyl-center {
            width: 20px;
            height: 20px;
            background: #ffd700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .music-note {
            font-size: 10px;
            animation: note-bounce 1.5s ease-in-out infinite;
        }

        @keyframes note-bounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        #volume-slider {
            width: 0;
            overflow: hidden;
            transition: width 0.3s;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            height: 6px;
            border-radius: 3px;
        }

        #audio-panel:hover #volume-slider {
            width: 100px;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
        }

        #game-stage {
            flex: 1;
            position: relative;
            width: 100%;
        }

        /* æ‹ŸçœŸå¡ç‰‡æ ·å¼ */
        .card {
            position: absolute;
            width: var(--card-w);
            height: var(--card-h);
            background: #fff;
            border: 2px solid #333;
            border-radius: var(--card-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            box-sizing: border-box;
            box-shadow: 0 4px 0 #888, 0 5px 10px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                left 0.3s ease-in-out,
                top 0.3s ease-in-out,
                filter 0.2s;
            z-index: 10;
        }

        /* ä¾§è¾¹åšåº¦æ„Ÿ */
        .card::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: -2px;
            right: -2px;
            height: 6px;
            background: #bbb;
            border: 2px solid #333;
            border-top: none;
            border-radius: 0 0 8px 8px;
            z-index: -1;
        }

        #audio-panel.muted .vinyl-record {
            filter: grayscale(1) contrast(0.5);
        }

        /* ä¼˜é›…å†…åœ†é™éŸ³çº¿ï¼š10:30 -> 4:30 (åæ–œæ  \) */
        #audio-panel.muted .vinyl-record::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 140%;
            height: 3px;
            background: rgba(230, 230, 230, 0.9);
            transform: translate(-50%, -50%) rotate(45deg);
            /* ä¿®æ­£æ–¹å‘è‡³åæ–œæ  */
            z-index: 20002;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .card.covered {
            filter: brightness(0.5) contrast(0.9);
            pointer-events: none;
        }

        .card.in-slot {
            box-shadow: none;
            pointer-events: none;
            transform: scale(0.9);
        }

        /* æœ¨è´¨æ‰˜ç›˜ï¼šæ‹ŸçœŸæœ¨çº¹ + å‡¹æ§½æ„Ÿ */
        .wooden-tray {
            width: 530px;
            /* ç²¾ç¡®é€‚é… 7 å¼ å¡çš„å®½åº¦ (66+6)*7 + padding */
            height: 96px;
            background:
                repeating-linear-gradient(90deg,
                    #8b5a2b 0,
                    #8b5a2b 10px,
                    #6e4220 10px,
                    #6e4220 12px),
                linear-gradient(to bottom, #8b5a2b, #5c3a17);
            background-blend-mode: overlay;
            border: 4px solid #5c3a17;
            border-radius: 12px;
            box-shadow:
                inset 0 4px 10px rgba(0, 0, 0, 0.5),
                0 10px 20px rgba(0, 0, 0, 0.4);
            padding: 10px;
            display: flex;
            justify-content: center;
            /* Flexbox å±…ä¸­ */
            align-items: center;
            gap: 4px;
            /* å¡ç‰‡é—´è· */
            position: relative;
        }

        /* æˆ˜æœ¯åŒºåŸŸ (Tactical Zone) - åŒ…å«ä¾§è¾¹ç›²å †å’Œä¸´æ—¶ç§»å‡ºåŒº */
        #tactical-zone {
            position: absolute;
            bottom: 220px;
            /* ä¸ shift-holder çš„ bottom ä¿æŒä¸€è‡´ */
            left: 0;
            right: 0;
            height: var(--card-h);
            /* ä¸å¡ç‰‡é«˜åº¦ä¸€è‡´ */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 60px;
            pointer-events: none;
            z-index: 6000;
        }

        /* ä¾§è¾¹ç›²å †å®¹å™¨ */
        .side-stack {
            position: relative;
            display: flex;
            align-items: center;
            /* å¡ç‰‡å‚ç›´å±…ä¸­ */
            height: var(--card-h);
            min-width: 80px;
            pointer-events: none;
        }

        /* å †å åŒºå¡ç‰‡æ ·å¼ï¼šæ°´å¹³å †å ï¼Œä¸‹å±‚åªéœ²å‡ºè¾¹ */
        .side-stack .card {
            position: absolute;
            top: 0;
            margin: 0 !important;
            pointer-events: auto; /* å…è®¸å¡ç‰‡è¢«ç‚¹å‡» */
        }

        /* ç§»å‡ºç¼“å†²åŒº (Shift Holder) - æˆ˜æœ¯ä¸­é—´å±‚ */
        #shift-holder {
            position: relative;
            /* æ”¹ä¸º relativeï¼Œå› ä¸ºåœ¨ tactical-zone å†… */
            display: flex;
            justify-content: center;
            gap: 12px;
            pointer-events: none;
            height: var(--card-h);
            /* ä¸å¡ç‰‡å®é™…é«˜åº¦ä¸€è‡´ (80px) */
            min-width: 240px;
            max-width: 80vw;
            /* å…è®¸æ‰©å±•ä»¥å®¹çº³æ›´å¤šå¡ç‰‡ */
            align-items: center;
            flex-wrap: nowrap;
            /* ä¸æ¢è¡Œï¼Œè®©å¡ç‰‡æ°´å¹³æ’åˆ— */
            overflow: visible;
        }

        /* æˆ˜æœ¯é“å…·æ  */
        .props-container {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            pointer-events: auto;
        }

        .prop-label {
            font-size: 14px;
            font-weight: 800;
            color: #5c3a17;
            /* æ·±è¤è‰²æ–‡å­—åŒ¹é…æœ¨çº¹ */
            margin-top: 4px;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        /* é“å…·æŒ‰é’®é‡ç»˜ï¼šå¡é€šæœ¨çº¹é£ */
        .prop-btn {
            width: 64px;
            height: 64px;
            background: #f4d29c;
            border: 3px solid #5c3a17;
            border-bottom-width: 6px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.1s;
        }

        .prop-btn:active {
            transform: translateY(4px);
            border-bottom-width: 3px;
            background: #eebb77;
        }

        .prop-btn svg {
            width: 28px;
            height: 28px;
            fill: #5c3a17;
            filter: drop-shadow(0 1px 0 rgba(255, 255, 255, 0.5));
        }

        .card.covered {
            filter: brightness(0.6) grayscale(0.4);
            /* æ›´æ˜æ˜¾çš„ç½®ç° */
            pointer-events: none;
        }

        .card.in-slot::after {
            display: none;
        }

        /* æ¶ˆé™¤çˆ†è£‚ç‰¹æ•ˆ */
        .card.matching {
            animation: card-match-burst 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
            z-index: 1000 !important;
        }

        @keyframes card-match-burst {
            0% {
                transform: scale(1);
                filter: brightness(1) drop-shadow(0 0 0px gold);
            }

            50% {
                transform: scale(1.3);
                filter: brightness(2) drop-shadow(0 0 15px gold);
            }

            100% {
                transform: scale(0.5);
                opacity: 0;
                filter: brightness(3) drop-shadow(0 0 30px gold);
            }
        }

        /* æè‡´å½’ä½ï¼šæ˜Ÿå°˜æµæ²™ç²’å­ (å¸¦å…‰æ™•ï¼Œæ…¢é™) */
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 2000;
            box-shadow: 0 0 8px currentColor;
            /* å‘å…‰æ˜Ÿå°˜æ„Ÿ */
            mix-blend-mode: screen;
        }

        @keyframes stardust-drift {
            0% {
                transform: translate(0, 0) scale(1.5);
                opacity: 1;
                filter: brightness(2);
            }

            15% {
                transform: translate(calc(var(--tx) * 0.8), calc(var(--ty) * 0.8)) scale(1.2);
                opacity: 1;
            }

            100% {
                /* 2.5s çš„æ¼«é•¿è½¨è¿¹ï¼ŒåŠ å…¥é‡åŠ›ä¸‹å è¶‹åŠ¿ (++ty) */
                transform: translate(var(--tx), calc(var(--ty) + 150px)) scale(0);
                opacity: 0;
            }
        }

        #footer {
            height: 200px;
            background: linear-gradient(180deg, var(--footer-bg) 0%, #2a3b14 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            /* é¡¶å¯¹é½ */
            padding-top: 10px;
            position: relative;
            z-index: 5000;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
        }

        #slot-container {
            width: 450px;
            /* å¢åŠ å®½åº¦ä»¥å®¹çº³ 7 å¼ å¤§å¡ç‰‡ */
            height: 94px;
            background: var(--slot-bg);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 2px;
            position: relative;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: transparent;
            /* ç§»é™¤é˜´å½±è’™ç‰ˆ */
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        #start-panel.overlay {
            background: transparent;
            z-index: 10001;
            /* ç›–è¿‡æ‰€æœ‰ */
        }

        /* é¦–é¡µéšè—åº•éƒ¨ footer å’Œé˜´å½± */
        body:has(#start-panel:not([style*="display: none"])) #footer {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #win-panel.overlay,
        #fail-panel.overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        /* æ‰«å…‰åŠ¨æ•ˆ */
        .shimmer {
            background: linear-gradient(90deg,
                    rgba(255, 215, 0, 0) 0%,
                    rgba(255, 215, 0, 0.8) 50%,
                    rgba(255, 215, 0, 0) 100%);
            background-size: 200% 100%;
            animation: shimmer 2.5s infinite linear;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            /* é‡è¦ï¼šè®©æ‰«å…‰é€å‡ºæ¥ */
        }

        @keyframes shimmer {
            0% {
                background-position: -100% 0;
            }

            100% {
                background-position: 100% 0;
            }
        }

        .btn {
            background: #ffcf44;
            color: #333;
            padding: 16px 60px;
            border-radius: 50px;
            font-weight: 1000;
            font-size: 1.4rem;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 6px 0 #d4a017;
            letter-spacing: 2px;
            position: relative;
            z-index: 10;
            /* å¾‹åŠ¨äº¤ç”± JS å¼•æ“é©±åŠ¨ï¼Œç§»é™¤ CSS å¼‚æ­¥åŠ¨ç”» */
        }

        .btn:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15), 0 6px 0 #d4a017;
        }

        .btn:active {
            transform: scale(0.92);
            box-shadow: 0 2px 0 #d4a017;
        }

        @keyframes ear-flutter {

            0%,
            100% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(-8deg);
            }
        }

        .ear-group {
            transform-origin: 30% 20%;
            animation: ear-flutter 2s infinite ease-in-out;
        }

        .ear-group-right {
            transform-origin: 70% 20%;
            animation: ear-flutter 2.2s infinite ease-in-out reverse;
        }

        /* è¿è¡Œä¸­çš„å°ç¾Š */
        .sheep-circle {
            position: relative;
            width: 300px;
            height: 300px;
            margin-bottom: 2rem;
        }

        .running-sheep {
            display: none;
        }

        .sheep-svg {
            position: absolute;
            width: 90px;
            height: 90px;
            /* é¡ºæ—¶é’ˆè·¯å¾„ */
            offset-path: path('M 150, 150 m -100, 0 a 100,100 0 1,1 200,0 a 100,100 0 1,1 -200,0');
            offset-rotate: auto 180deg;
            animation: move-around 10s linear infinite;
            /* åŠ å¿«ä¸€ä¸¢ä¸¢ */
        }

        /* ç¾Šç¾¤å‘¼å¸ä¸ç¼©æ”¾å¾®åŠ¨ */
        .sheep-pulse {
            animation: pulse-mini 0.8s ease-in-out infinite alternate;
            transform-origin: center bottom;
        }

        @keyframes pulse-mini {
            from {
                transform: scale(0.98);
            }

            to {
                transform: scale(1.02);
            }
        }

        .sheep-shadow {
            position: absolute;
            width: 80px;
            height: 20px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 50%;
            bottom: 12px;
            /* è´´åˆè¹„éƒ¨ */
            left: 20px;
            filter: blur(3px);
            z-index: -1;
            animation: pulse-mini 2s infinite ease-in-out;
        }

        .leg {
            transform-origin: top;
            transform-box: fill-box;
            animation: leg-swing 0.3s ease-in-out infinite alternate;
        }

        .leg-back {
            animation-delay: -0.2s;
        }

        @keyframes leg-swing {
            0% {
                transform: rotate(-15deg);
            }

            100% {
                transform: rotate(15deg);
            }
        }

        @keyframes move-around {
            0% {
                offset-distance: 0%;
            }

            100% {
                offset-distance: 100%;
            }
        }
    </style>
</head>

<body>
    <svg style="display: none;">
        <symbol id="sheep-def" viewBox="-10 -10 150 130">
            <g class="sheep-body-group sheep-pulse">
                <!-- æ˜¾åŒ–é•¿è…¿ï¼šèµ·ç‚¹æ›´é«˜ (y=28)ï¼Œé•¿åº¦å»¶ä¼¸è‡³ 38px -->
                <rect class="leg" x="48" y="28" width="13" height="38" rx="5" fill="#1a1a1a" />
                <rect class="leg leg-back" x="65" y="30" width="13" height="38" rx="5" fill="#1a1a1a" />
                <rect class="leg" x="80" y="30" width="13" height="38" rx="5" fill="#1a1a1a" />
                <rect class="leg leg-back" x="93" y="28" width="13" height="38" rx="5" fill="#1a1a1a" />

                <!-- â€œçº¸ç‰‡çº§â€å‰ªå½±èº«ä½“ (y=35)ï¼Œæè‡´ææ‹‰æ”¶è…¹ -->
                <path
                    d="M50 25 A18 18 0 0 1 75 12 A22 22 0 0 1 110 28 A18 18 0 0 1 123 35 A20 20 0 0 1 100 35 A25 25 0 0 1 45 35 A18 18 0 0 1 12 32 A20 20 0 0 1 50 25"
                    fill="#fff" stroke="#1a1a1a" stroke-width="3.2" />

                <!-- å¤´éƒ¨ï¼šé”¥å½¢çµåŠ¨ç˜¦è€³ï¼ˆæ ¹éƒ¨ç»†ã€å°–ç«¯åœ†ï¼‰ -->
                <g transform="translate(10, 15)">
                    <ellipse cx="25" cy="22" rx="22" ry="19" fill="#333" stroke="#1a1a1a" stroke-width="3" />
                    <g class="ear-group">
                        <path d="M5 8 Q-5 0 -12 10 Q-15 18 -6 18 L2 14" fill="#222" stroke="#1a1a1a"
                            stroke-width="2.2" />
                    </g>
                    <g class="ear-group-right">
                        <path d="M45 8 Q55 0 62 10 Q65 18 56 18 L48 14" fill="#222" stroke="#1a1a1a"
                            stroke-width="2.2" />
                    </g>
                    <!-- é¢éƒ¨ -->
                    <circle cx="16" cy="15" r="9.5" fill="white" stroke="#1a1a1a" stroke-width="2" />
                    <circle cx="34" cy="15" r="9.5" fill="white" stroke="#1a1a1a" stroke-width="2" />
                    <circle cx="18" cy="12" r="3.5" fill="#1a1a1a" />
                    <circle cx="36" cy="12" r="3.5" fill="#1a1a1a" />
                    <path d="M21 32 Q25 35 29 32" stroke="#1a1a1a" fill="none" stroke-width="2.5"
                        stroke-linecap="round" />
                </g>
            </g>
        </symbol>
    </svg>

    <div id="audio-panel">
        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.7" oninput="setVolume(this.value)">
        <div id="music-btn" class="vinyl-record" onclick="toggleMusic()">
            <div class="vinyl-center">
                <span class="music-note" style="color: #1a260d;">â™«</span>
            </div>
        </div>
    </div>

    <div id="game-container">
        <div class="grass-bg" id="grass-bg"></div>
        <div id="game-stage"></div>

        <!-- æˆ˜æœ¯åŒºåŸŸï¼šåŒ…å«ä¾§è¾¹ç›²å †å’Œä¸´æ—¶ç§»å‡ºåŒº -->
        <div id="tactical-zone">
            <div id="side-stack-left" class="side-stack"></div>
            <div id="shift-holder"></div>
            <div id="side-stack-right" class="side-stack"></div>
        </div>

        <div id="footer">
            <div id="slot-container" class="wooden-tray"></div>

            <div class="props-container">
                <!-- ç§»å‡º (Shift) -->
                <div class="prop-btn" onclick="onPropShift()">
                    <svg viewBox="0 0 24 24">
                        <path d="M5 11h14v2H5z" display="none" />
                        <!-- å‘ä¸Šç®­å¤´ -->
                        <path d="M12 4l-7 7h5v9h4v-9h5z" stroke-width="0" />
                    </svg>
                    <span class="prop-label">ç§»å‡º</span>
                </div>

                <!-- æ’¤å› (Undo) -->
                <div class="prop-btn" onclick="onPropUndo()">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z" />
                    </svg>
                    <span class="prop-label">æ’¤å›</span>
                </div>

                <!-- æ´—ç‰Œ (Shuffle) -->
                <div class="prop-btn" onclick="onPropShuffle()">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" />
                    </svg>
                    <span class="prop-label">æ´—ç‰Œ</span>
                </div>
            </div>
        </div>
    </div>

    <div id="start-panel" class="overlay">
        <div class="sheep-circle">
            <!-- å½±åˆ†èº«è·‘åŠ¨ï¼šç´§å‡‘æ’åˆ—ï¼Œå®ç°è¿½éšæ„Ÿ -->
            <!-- ç²¾å¯†å‘¼å¸é˜Ÿå½¢ï¼šæ­¥é•¿ -0.95sï¼Œå®ç°â€œå†é è¿‘ä¸€ä¸¢ä¸¢â€çš„é«˜çº§æ„Ÿ -->
            <div class="sheep-svg" style="animation-delay: 0s; z-index: 40;">
                <div class="sheep-shadow"></div><svg viewBox="-10 -10 150 130">
                    <use href="#sheep-def" />
                </svg>
            </div>
            <div class="sheep-svg" style="animation-delay: -0.95s; z-index: 30;">
                <div class="sheep-shadow"></div><svg viewBox="-10 -10 150 130">
                    <use href="#sheep-def" />
                </svg>
            </div>
            <div class="sheep-svg" style="animation-delay: -1.9s; z-index: 20;">
                <div class="sheep-shadow"></div><svg viewBox="-10 -10 150 130">
                    <use href="#sheep-def" />
                </svg>
            </div>
            <div class="sheep-svg" style="animation-delay: -2.85s; z-index: 10;">
                <div class="sheep-shadow"></div><svg viewBox="-10 -10 150 130">
                    <use href="#sheep-def" />
                </svg>
            </div>
        </div>
        <div id="title-wrapper" style="transition: transform 0.05s ease-out;">
            <h1 class="text-8xl font-black mb-6 italic"
                style="background: linear-gradient(180deg, #fff2ac 0%, #d4a017 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.4));">
                ç¾Šäº†ä¸ªç¾Š</h1>
        </div>
        <div id="slogan-wrapper" class="relative mb-10 pb-4" style="transition: transform 0.05s ease-out;">
            <p class="text-2xl font-bold tracking-widest"
                style="color: rgba(76, 104, 40, 0.7); text-shadow: 1px 1px 0 rgba(255,255,255,0.3);">æ¯å¤©ä¸€æ¬¡åŠ¨æ¬¡æ‰“æ¬¡</p>
            <p class="text-2xl font-bold tracking-widest absolute inset-0 shimmer"
                style="color: transparent; -webkit-background-clip: text; background-clip: text;">æ¯å¤©ä¸€æ¬¡åŠ¨æ¬¡æ‰“æ¬¡</p>
        </div>
        <div id="btn-wrapper" style="transition: transform 0.05s ease-out;">
            <div class="btn transform transition hover:scale-110 shadow-2xl" id="start-btn" onclick="startGame()"
                style="background: linear-gradient(180deg, #ffcf44 0%, #f7d047 100%); color: #2b3d14;">ä¸ æœ æ¥ æˆ˜</div>
        </div>
    </div>

    <div id="win-panel" class="overlay" style="display:none">
        <div class="text-6xl mb-4">ğŸ‘‘</div>
        <h1 class="text-3xl font-bold">é€šå…³ç¬¬ä¸€å…³ï¼</h1>
        <p class="mt-2 text-yellow-400">ç¬¬äºŒå…³æ‰æ˜¯å™©æ¢¦çš„å¼€å§‹...</p>
        <div class="btn" onclick="startLevel2()">æŒ‘æˆ˜ç¬¬äºŒå…³</div>
    </div>

    <div id="fail-panel" class="overlay" style="display:none">
        <div class="text-6xl mb-4">ğŸ–</div>
        <h1 class="text-3xl font-bold">æ§½ä½æ»¡äº†ï¼</h1>
        <p class="mt-2">ä½ æˆäº†éš”å£è€ç‹çš„ç›˜ä¸­é¤</p>
        <div class="btn" onclick="resetGameToLevel1()">ä¸æœå†æˆ˜</div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let bgmSource, analyser, dataArray, gainNode;
        let bgmElement; // Streaming element
        const BGM_URL = 'https://cdn.jsdelivr.net/gh/colddew/cursor@main/mini-games/sheep.MP3';

        let isMutedManually = false;

        async function initAudio() {
            try {
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                if (isMutedManually) return;

                if (!bgmElement) {
                    // å½»åº•ä¼˜åŒ–ï¼šä½¿ç”¨ HTML5 Audio Streaming æ¥å…¥ Web Audio API
                    // ä¼˜åŠ¿ï¼šè¾¹ä¸‹è¾¹æ”¾ï¼Œç¬é—´å“èµ·ï¼Œå®Œå…¨ä¸å¡ä¸»çº¿ç¨‹
                    bgmElement = new Audio();
                    bgmElement.src = BGM_URL;
                    bgmElement.crossOrigin = "anonymous";
                    bgmElement.loop = true;

                    bgmSource = audioCtx.createMediaElementSource(bgmElement);
                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 256;
                    dataArray = new Uint8Array(analyser.frequencyBinCount);

                    gainNode = audioCtx.createGain();
                    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);

                    bgmSource.connect(analyser);
                    analyser.connect(gainNode);
                    gainNode.connect(audioCtx.destination);

                    bgmElement.play().then(() => {
                        document.getElementById('music-btn').classList.add('playing');
                    }).catch(e => console.warn("Auto-play blocked, waiting for interaction"));
                } else if (bgmElement.paused) {
                    bgmElement.play();
                    document.getElementById('music-btn').classList.add('playing');
                }
            } catch (e) {
                console.warn('Audio streaming init failed:', e);
            }
        }


        function toggleMusic() {
            const panel = document.getElementById('audio-panel');
            if (!bgmElement) {
                isMutedManually = false;
                initAudio();
                panel.classList.remove('muted');
                return;
            }
            if (!bgmElement.paused) {
                bgmElement.pause();
                isMutedManually = true;
                document.getElementById('music-btn').classList.remove('playing');
                panel.classList.add('muted');
            } else {
                audioCtx.resume();
                bgmElement.play();
                isMutedManually = false;
                document.getElementById('music-btn').classList.remove('playing');
                panel.classList.remove('muted');
            }
        }
        // é»˜è®¤å°è¯•æ¢å¤ç¯å¢ƒ
        window.addEventListener('mousedown', () => { if (audioCtx.state === 'suspended') initAudio(); }, { once: true });
        window.addEventListener('touchstart', () => { if (audioCtx.state === 'suspended') initAudio(); }, { once: true });

        function setVolume(val) {
            if (gainNode) {
                gainNode.gain.setTargetAtTime(val, audioCtx.currentTime, 0.1);
            }
        }

        function playSound(type) {
            if (isMutedManually) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;

            if (type === 'match') {
                // é£˜æ¸ºé£é“ƒ (Ethereal Wind Chime Flutter): æ¨¡æ‹Ÿé£æ‹‚è¿‡é‡‘å±/ç»ç’ƒé£é“ƒçš„ç²¾çµæ„Ÿ
                const masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                masterGain.gain.setValueAtTime(0, now);
                masterGain.gain.linearRampToValueAtTime(0.8, now + 0.01);
                masterGain.gain.exponentialRampToValueAtTime(0.001, now + 2.5);

                const filter = audioCtx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.setValueAtTime(1000, now);
                filter.connect(masterGain);

                const scale = [1318.51, 1567.98, 1760.00, 1975.53, 2349.32, 2637.02];
                for (let i = 0; i < 10; i++) {
                    const d = Math.random() * 0.4;
                    const f = scale[Math.floor(Math.random() * scale.length)];

                    // 1. å†²å‡»å±‚ (The Strike)
                    const oscS = audioCtx.createOscillator();
                    const modS = audioCtx.createOscillator();
                    const mgS = audioCtx.createGain();
                    const envS = audioCtx.createGain();
                    oscS.frequency.setValueAtTime(f, now + d);
                    modS.frequency.setValueAtTime(f * 1.5, now + d);
                    mgS.gain.setValueAtTime(f * 0.4, now + d);
                    mgS.gain.exponentialRampToValueAtTime(0.01, now + d + 0.1);
                    envS.gain.setValueAtTime(0, now + d);
                    envS.gain.linearRampToValueAtTime(0.3, now + d + 0.005);
                    envS.gain.exponentialRampToValueAtTime(0.001, now + d + 0.12);
                    modS.connect(mgS); mgS.connect(oscS.frequency);
                    oscS.connect(envS); envS.connect(filter);

                    // 2. å…±æŒ¯å±‚ (The Resonance)
                    const oscR = audioCtx.createOscillator();
                    const envR = audioCtx.createGain();
                    oscR.frequency.setValueAtTime(f, now + d);
                    envR.gain.setValueAtTime(0, now + d);
                    envR.gain.linearRampToValueAtTime(0.15, now + d + 0.05);
                    envR.gain.exponentialRampToValueAtTime(0.001, now + d + 2.0);
                    oscR.connect(envR); envR.connect(filter);

                    oscS.start(now + d); modS.start(now + d); oscR.start(now + d);
                    oscS.stop(now + d + 0.2); modS.stop(now + d + 0.2); oscR.stop(now + d + 2.2);
                }
                // å¾®å…‰é—ªçƒ (Elven Shimmer)
                for (let j = 0; j < 6; j++) {
                    const d = Math.random() * 0.8;
                    const f = 8000 + Math.random() * 4000;
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.frequency.setValueAtTime(f, now + d);
                    g.gain.setValueAtTime(0, now + d);
                    g.gain.linearRampToValueAtTime(0.04, now + d + 0.01);
                    g.gain.exponentialRampToValueAtTime(0.001, now + d + 0.15);
                    o.connect(g); g.connect(masterGain);
                    o.start(now + d); o.stop(now + d + 0.2);
                }
            } else if (type === 'fail') {
                // è¡å’Œä¸§çš„å¤±è½é•¿éŸ³ (Swinging Sinking Fail): Vibrato Sawtooth
                const dur = 1.6;
                const mg = audioCtx.createGain();
                mg.connect(audioCtx.destination);
                mg.gain.setValueAtTime(0.5, now);
                mg.gain.exponentialRampToValueAtTime(0.001, now + dur);

                const osc = audioCtx.createOscillator();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(380, now);
                osc.frequency.exponentialRampToValueAtTime(45, now + dur);

                // LFO äº§ç”Ÿçš„â€œè¡â€æ„Ÿ (Vibrato)
                const lfo = audioCtx.createOscillator();
                const lg = audioCtx.createGain();
                lfo.frequency.setValueAtTime(6, now); // 6Hz é¢¤æŠ–
                lg.gain.setValueAtTime(20, now); // 20Hz çš„é¢‘åå˜åŒ–
                lfo.connect(lg);
                lg.connect(osc.frequency);

                osc.connect(mg);
                lfo.start(now); osc.start(now);
                lfo.stop(now + dur); osc.stop(now + dur);
            } else if (type === 'click') {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                g.gain.setValueAtTime(0.3, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.connect(g);
                g.connect(audioCtx.destination);
                osc.start(); osc.stop(now + 0.1);
            }
        }

        function initGrass() {
            const container = document.getElementById('grass-bg');
            container.innerHTML = '';
            const types = [
                `<path d="M5 25 Q10 10 15 25 Q20 10 25 25" />`, // m
                `<path d="M2 25 Q7 5 12 25 Q17 5 22 25 Q27 5 32 25" />`, // triple m
                `<path d="M10 25 L15 15 L20 25" stroke-opacity="0.5" />` // rare v/^
            ];
            for (let i = 0; i < 35; i++) {
                const grass = document.createElement('div');
                grass.className = 'grass';
                grass.style.left = Math.random() * 95 + '%';
                grass.style.top = Math.random() * 95 + '%';
                grass.innerHTML = `<svg viewBox="0 0 35 30">${types[Math.floor(Math.random() * types.length)]}</svg>`;
                container.appendChild(grass);
            }
        }

        function animateGrass() {
            requestAnimationFrame(animateGrass);

            let ratio = 0;
            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                const bassRange = 8;
                for (let i = 0; i < bassRange; i++) sum += dataArray[i];
                const avg = sum / bassRange;
                ratio = avg / 255;
            } else {
                // é™é»˜æ´»åŠ›ç®—æ³•ï¼šå½“éŸ³ä¹æœªåŠ è½½æˆ–é™éŸ³æ—¶ï¼Œæä¾›åŸºç¡€çš„æ…¢èŠ‚å¥å‘¼å¸
                ratio = (Math.sin(Date.now() / 1500) + 1) * 0.05;
            }

            const bounce = ratio * 45;
            const scale = 1 + ratio * 0.18;
            const btnScale = 1 + ratio * 0.35;

            // UI å®æ—¶å¾‹åŠ¨
            const title = document.getElementById('title-wrapper');
            const slogan = document.getElementById('slogan-wrapper');
            const btn = document.getElementById('btn-wrapper');
            if (title) title.style.transform = `scale(${scale})`;
            if (slogan) slogan.style.transform = `scale(${1 + ratio * 0.15})`;
            if (btn) btn.style.transform = `scale(${btnScale})`;

            document.querySelectorAll('.grass').forEach((g, idx) => {
                const shift = Math.sin(Date.now() / 250 + idx) * 6;
                g.style.transform = `translateY(${-bounce}px) rotate(${shift}deg)`;
                // å³ä½¿é™é»˜ä¹Ÿæœ‰åŸºç¡€é€æ˜åº¦
                g.style.opacity = 0.3 + ratio * 0.7;
            });
        }

        const ICONS = ['ğŸ', 'ğŸ“', 'ğŸ¥•', 'ğŸŒ½', 'ğŸ‡', 'ğŸ„', 'ğŸŒ³', 'ğŸ§¶', 'ğŸ””', 'ğŸ¥›', 'ğŸ”¥', 'ğŸ§±', 'ğŸ¥¦', 'ğŸ‰', 'ğŸ¥¨', 'ğŸ°'];
        let allCards = [];
        let slotCards = [];
        let shiftCards = []; // ç§»å‡ºåŒºå¡ç‰‡åŠå…¶é€»è¾‘
        let moveHistory = []; // æ’¤å›æˆ˜æœ¯æ ˆ
        let currentLevel = 1;
        let gameState = 'playing'; // 'playing', 'won', 'lost'

        const stage = document.getElementById('game-stage');
        const slotContainer = document.getElementById('slot-container');

        window.onload = () => {
            initGrass();
            animateGrass(); // å¯åŠ¨è§†è§‰å¾ªç¯
        };

        function startGame() {
            document.getElementById('start-panel').style.display = 'none';
            setTimeout(initAudio, 50); // å¾®å»¶åï¼Œç¡®ä¿é¢æ¿åˆ‡æ¢æµç•…
            initLevel(1);
        }

        function initLevel(level) {
            currentLevel = level;
            stage.innerHTML = '';
            allCards = [];
            slotCards = [];
            gameState = 'playing';
            updateSlotUI();

            const stageW = stage.clientWidth;
            const stageH = stage.clientHeight;
            const cx = stageW / 2;

            // åº•éƒ¨é®ç½©å±‚é«˜åº¦çº¦ 200pxï¼ˆæœ¨è´¨æ‰˜ç›˜ + æŒ‰é’® + è¾¹è·ï¼‰
            const maskSafeBottom = 200;

            // ä» CSS å˜é‡è¯»å–å¡ç‰‡å°ºå¯¸ï¼Œç¡®ä¿ä¸ CSS å®šä¹‰ä¸€è‡´
            const cardWidth = parseInt(getComputedStyle(document.documentElement)
                .getPropertyValue('--card-w'));
            const cardHeight = parseInt(getComputedStyle(document.documentElement)
                .getPropertyValue('--card-h'));

            if (level === 1) {
                // ç¬¬ä¸€å…³ï¼š3Ã—3 ä¹å®«æ ¼å¹³é“ºï¼Œä¸å åŠ ï¼Œæ¯ç§å›¾æ ‡3å¼ ï¼Œå…±9å¼ å¡ç‰‡
                // æ¸…é™¤å †å åŒºçš„å¡ç‰‡
                const leftStack = document.getElementById('side-stack-left');
                const rightStack = document.getElementById('side-stack-right');
                if (leftStack) leftStack.innerHTML = '';
                if (rightStack) rightStack.innerHTML = '';

                const pool = [ICONS[0], ICONS[1], ICONS[2]];
                let deck = [];
                // æ¯ç§å›¾æ ‡3å¼ ï¼Œç¡®ä¿å¯ä»¥å®Œæˆæ¶ˆé™¤
                pool.forEach(icon => {
                    for (let i = 0; i < 3; i++) {
                        deck.push(icon);
                    }
                });
                deck.sort(() => Math.random() - 0.5);

                const rows = 3;
                const cols = 3;
                const gapX = 15; // å¡ç‰‡æ°´å¹³é—´è·
                const gapY = 12; // å¡ç‰‡å‚ç›´é—´è·

                // è®¡ç®—æ•´ä¸ªæ–¹é˜µçš„å°ºå¯¸
                const gridWidth = cols * cardWidth + (cols - 1) * gapX;
                const gridHeight = rows * cardHeight + (rows - 1) * gapY;

                // è®¾ç½®åˆç†çš„é¡¶éƒ¨è¾¹è·ï¼Œè®©ä¹å®«æ ¼å’Œä¸´æ—¶åŒºä¿æŒé€‚å½“è·ç¦»
                const topMargin = 100; // é€‚ä¸­çš„é¡¶éƒ¨è¾¹è·ï¼Œä¸ä¸´æ—¶åŒºä¿æŒåˆé€‚è·ç¦»

                const startX = cx - gridWidth / 2;
                const startY = topMargin;

                deck.forEach((icon, i) => {
                    const col = i % cols;
                    const row = Math.floor(i / cols);
                    const x = startX + col * (cardWidth + gapX);
                    const y = startY + row * (cardHeight + gapY);
                    createCard(icon, x, y, i);
                });

            } else {
                // ç¬¬äºŒå…³ï¼šä¾§è¾¹ç›²å † + æ ¸å¿ƒé‡‘å­—å¡”
                const poolSize = ICONS.length;
                const totalCards = 180;
                const totalGroups = totalCards / 3;
                let deck = [];
                for (let i = 0; i < totalGroups; i++) {
                    const icon = ICONS[i % poolSize];
                    deck.push(icon, icon, icon);
                }
                deck.sort(() => Math.random() - 0.5);

                const centerX = stageW / 2;
                const shiftZoneHalfWidth = 120; // ä¸­é—´ç•™ç»™ç§»å‡ºåŒºçš„å®½åº¦/2

                const sideStackCount = 18;
                const leftStack = deck.splice(0, sideStackCount);
                const rightStack = deck.splice(0, sideStackCount);

                // è·å–ä¾§è¾¹ç›²å †å®¹å™¨
                const leftStackContainer = document.getElementById('side-stack-left');
                const rightStackContainer = document.getElementById('side-stack-right');

                // å·¦ä¾§ç›²å †ï¼šä»å³å‘å·¦æ°´å¹³å †å ï¼Œåªæ˜¾ç¤ºæœ€å³è¾¹ï¼ˆé è¿‘ä¸­é—´ï¼‰çš„å¡ç‰‡
                leftStack.forEach((icon, i) => {
                    // è¶Šåé¢çš„å¡ç‰‡å‘å·¦åç§»ï¼Œå½¢æˆå †å æ•ˆæœ
                    const offsetX = -(sideStackCount - 1 - i) * 6;
                    createCard(icon, offsetX, 0, 600 + i, leftStackContainer, i);
                });

                // å³ä¾§ç›²å †ï¼šå‘å³ä¼¸å±•ï¼Œå·¦è¾¹å‹å³è¾¹ï¼Œæ˜¾ç¤ºæœ€å·¦è¾¹çš„å¡ç‰Œ
                rightStack.forEach((icon, i) => {
                    // æ­£åç§»ï¼Œå‘å³ä¼¸å±•
                    // offset ä» 102ï¼ˆè¿œç¦»ä¸­é—´ï¼‰åˆ° 0ï¼ˆé è¿‘ä¸­é—´ï¼‰
                    const offsetX = (sideStackCount - 1 - i) * 6;
                    // z-index æ­£å¸¸ï¼ši è¶Šå¤§è¶Šé è¿‘ä¸­é—´ï¼ŒzIndex è¶Šé«˜ï¼Œæ˜¾ç¤ºæœ€å·¦è¾¹çš„å¡ç‰Œ
                    createCard(icon, offsetX, 0, 600 + i, rightStackContainer, i);
                });

                // é‡‘å­—å¡”åŒºåŸŸï¼ˆä¸»å¡ç‰‡åŒºï¼‰
                const pyWidth = stageW * 0.5; // å®½åº¦ï¼Œè®©å¡ç‰‡æ°´å¹³æ–¹å‘åˆ†æ•£
                const pyMinX = (stageW - pyWidth) / 2;

                // tactical-zone: position: absolute; bottom: 220px; height: cardHeight
                // tactical-zone ç›¸å¯¹äº game-container (è§†å£) å®šä½
                // tactical-zone é¡¶éƒ¨ä½ç½®ï¼ˆè§†å£åæ ‡ï¼‰= è§†å£é«˜åº¦ - 220 - cardHeight
                // å¡ç‰‡åæ ‡æ˜¯ç›¸å¯¹äº game-stage çš„ï¼Œgame-stage ä»è§†å£é¡¶éƒ¨å¼€å§‹
                const viewportHeight = window.innerHeight;
                const tacticalZoneTop = viewportHeight - 220 - cardHeight;
                const pyTopY = 60; // ä» 60px å¼€å§‹
                const pyMaxY = tacticalZoneTop - cardHeight - 30; // å¡ç‰‡é¡¶éƒ¨æœ€å¤§å€¼ï¼Œç¦»ä¸´æ—¶åŒºç•™30pxé—´è·

                deck.forEach((icon, i) => {
                    const x = pyMinX + Math.random() * pyWidth;
                    // å¡ç‰Œåœ¨æ•´ä¸ªå¯ç”¨é«˜åº¦èŒƒå›´å†…éšæœºåˆ†å¸ƒ
                    const y = pyTopY + Math.random() * (pyMaxY - pyTopY);
                    createCard(icon, x, y, 100 + i);
                });
            }
            checkCover();
        }

        function createCard(icon, x, y, z, container = null, stackIndex = -1) {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = icon;

            // åˆ¤æ–­æ˜¯å¦ä¸ºå †å åŒºå®¹å™¨
            const isSideStack = container && container.classList.contains('side-stack');

            if (isSideStack && stackIndex >= 0) {
                // å †å åŒºï¼šæ°´å¹³å †å ï¼Œä½¿ç”¨ x å‚æ•°ä½œä¸ºæ°´å¹³åç§»
                div.style.position = 'absolute';
                div.style.top = '0';
                div.style.left = `${x}px`; // æ°´å¹³åç§»ï¼Œä¸‹å±‚åªéœ²å‡ºè¾¹
                div.style.zIndex = z;
            } else if (container) {
                // å…¶ä»–å®¹å™¨ï¼šç›¸å¯¹å®šä½
                div.style.position = 'relative';
                div.style.left = `${x}px`;
                div.style.top = '0';
                div.style.zIndex = z;
            } else {
                // åœ¨ game-stage ä¸­ä½¿ç”¨ç»å¯¹å®šä½
                div.style.position = 'absolute';
                div.style.left = `${x}px`;
                div.style.top = `${y}px`;
                div.style.zIndex = z;
            }

            const cardObj = { el: div, icon, x, y, z, state: 'stage' };
            // å †å åŒºçš„å¡ç‰‡ä½¿ç”¨ç‰¹æ®ŠçŠ¶æ€ï¼Œä¸å‚ä¸æ´—ç‰Œ
            if (isSideStack && stackIndex >= 0) {
                cardObj.state = 'side-stack';
            }
            div.onclick = () => onCardClick(cardObj);

            if (container) {
                container.appendChild(div);
            } else {
                stage.appendChild(div);
            }
            allCards.push(cardObj);
        }

        function onCardClick(card) {
            if (gameState !== 'playing') return;
            // ç§»å‡ºåŒºçš„å¡ç‰‡ç‚¹å‡»æ—¶æš‚ä¸å¤„ç†ï¼ˆæˆ–è€…æ˜¯ç§»å›æ§½ä½ï¼ŸåŸç‰ˆä¸æ”¯æŒç§»å›ï¼Œåªèƒ½ç­‰ç€æ¶ˆï¼‰
            // è¿™é‡Œæˆ‘ä»¬å‡è®¾ç§»å‡ºåŒºçš„å¡ç‰‡å·²ç»æ˜¯ shifted çŠ¶æ€ï¼Œä¸å“åº” click (é™¤éå®ç°ç‚¹å‡»ç§»å›åŠŸèƒ½)
            if (card.state === 'shifted') return;

            if (card.state !== 'stage' || card.el.classList.contains('covered')) return;
            if (slotCards.length >= 7) return;

            playSound('click');

            // è®°å½•æ“ä½œç”¨äºæ’¤å›
            moveHistory.push({
                card: card,
                fromX: card.x,
                fromY: card.y,
                fromZ: card.z,
                state: 'stage'
            });

            card.state = 'slot';
            card.el.classList.add('in-slot');

            // æŸ¥æ‰¾ç›¸åŒå›¾æ ‡çš„ä½ç½® (æ‰‹åŠ¨æŸ¥æ‰¾ä»¥ä¿è¯å…¼å®¹æ€§)
            let lastIdx = -1;
            for (let i = slotCards.length - 1; i >= 0; i--) {
                if (slotCards[i].icon === card.icon) {
                    lastIdx = i;
                    break;
                }
            }
            const targetIdx = lastIdx === -1 ? slotCards.length : lastIdx + 1;
            slotCards.splice(targetIdx, 0, card);

            updateSlotUI();
            checkCover();

            // æ£€æŸ¥æ¶ˆé™¤ (åŒ…å«ç§»å‡ºåŒºçš„å¡ç‰‡)
            checkMatch();
        }

        function checkMatch() {
            // åˆå¹¶æ§½ä½å’Œç§»å‡ºåŒºçš„æ‰€æœ‰å¡ç‰‡
            const allActiveCards = [...slotCards, ...shiftCards];

            // ç»Ÿè®¡æ¯ç§å›¾æ ‡çš„æ•°é‡
            const iconCounts = {};
            allActiveCards.forEach(c => {
                iconCounts[c.icon] = iconCounts[c.icon] || [];
                iconCounts[c.icon].push(c);
            });

            // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªè¾¾åˆ°3å¼ çš„å›¾æ ‡
            for (let icon in iconCounts) {
                const sameIcons = iconCounts[icon];
                if (sameIcons.length >= 3) {
                    // ä¼˜å…ˆæ¶ˆé™¤æœ€æ—©è¿›å…¥çš„å¡ç‰‡ï¼ˆç¬¦åˆç›´è§‰ï¼‰
                    const matchTriple = sameIcons.slice(0, 3);

                    playSound('match');
                    matchTriple.forEach(c => {
                        const rect = c.el.getBoundingClientRect();
                        createFirework(rect.left + rect.width / 2, rect.top + rect.height / 2);
                        c.el.classList.add('matching');
                    });

                    setTimeout(() => {
                        matchTriple.forEach(c => {
                            if (c.el.parentNode) c.el.parentNode.removeChild(c.el);
                            // ä»å„ä¸ªæ•°ç»„ä¸­ç§»é™¤
                            let idx = slotCards.indexOf(c);
                            if (idx > -1) slotCards.splice(idx, 1);

                            idx = shiftCards.indexOf(c);
                            if (idx > -1) shiftCards.splice(idx, 1);

                            idx = allCards.indexOf(c);
                            if (idx > -1) allCards.splice(idx, 1);

                            // æ¸…é™¤å†å²
                            moveHistory = moveHistory.filter(h => h.card !== c);
                        });

                        updateSlotUI();
                        // ç§»å‡ºåŒºä¹Ÿè¦æ•´ç† UI (è™½ç„¶é€šå¸¸åªæ˜¯é™æ€ä½ç½®ï¼Œä½†å¦‚æœæ¶‰åŠæ¶ˆé™¤éœ€è¦ç§»é™¤ DOM)
                        // ä¸Šé¢ removeChild å·²ç»å¤„ç†äº† visual, æ•°ç»„ä¹Ÿæ¸…ç†äº†

                        checkWin();
                        // ç»§ç»­æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–å¯ä»¥æ¶ˆé™¤çš„
                        checkMatch();
                    }, 350);
                    return;
                }
            }

            // æ£€æŸ¥å¤±è´¥æ¡ä»¶
            if (slotCards.length >= 7) {
                gameState = 'lost';
                playSound('fail');
                setTimeout(() => {
                    document.getElementById('fail-panel').style.display = 'flex';
                }, 400);
            }
        }

        function checkWin() {
            if (allCards.length === 0) {
                gameState = 'won';
                if (currentLevel === 1) {
                    document.getElementById('win-panel').style.display = 'flex';
                } else {
                    alert("ğŸ‰ å¥‡è¿¹ï¼ä½ é€šè¿‡äº†ç¬¬äºŒå…³ï¼");
                }
            }
        }

        function updateSlotUI() {
            // ä½¿ç”¨ Flexbox è‡ªåŠ¨å¸ƒå±€ï¼Œä¸å†è¿›è¡Œ absolute è®¡ç®—
            // å…ˆæŒ‰é¡ºåºä» DOM ä¸­ç§»é™¤å¹¶é‡æ–°æ·»åŠ ä»¥ä¿è¯é¡ºåº
            slotContainer.innerHTML = '';
            slotCards.forEach((card, i) => {
                slotContainer.appendChild(card.el);

                // æ¸…é™¤ absolute å’Œæ—§å®šä½
                card.el.style.position = 'static';
                card.el.style.left = '';
                card.el.style.top = '';
                card.el.style.zIndex = 'auto'; // Flex item z-index
                card.el.style.transform = 'scale(0.9)'; // ä¿æŒ slot ç¼©æ”¾

                // ç§»é™¤é£å…¥åŠ¨ç”»å¯èƒ½æ®‹ç•™çš„ style
                // å®é™…ä¸Š CSS .in-slot å·²ç»å¤„ç†äº† scale
            });
        }

        function checkCover() {
            allCards.forEach(c1 => {
                if (c1.state !== 'stage') return;
                let isCovered = false;
                for (let c2 of allCards) {
                    if (c2.state === 'stage' && c2.z > c1.z) {
                        // åˆ¤å®šè°ƒæ•´ä»¥é€‚åº”å¤§å¡ç‰‡ï¼šå¢å¤§é‡å åˆ¤å®šé˜ˆå€¼
                        const overlapX = Math.abs(c1.x - c2.x) < 58;
                        const overlapY = Math.abs(c1.y - c2.y) < 70;
                        if (overlapX && overlapY) {
                            isCovered = true;
                            break;
                        }
                    }
                }
                c1.el.classList.toggle('covered', isCovered);
            });
        }

        function startLevel2() {
            document.getElementById('win-panel').style.display = 'none';
            initLevel(2);
        }

        function createFirework(x, y) {
            const colors = ['#FFD700', '#FF4500', '#00FA9A', '#1E90FF', '#FF1493', '#FFFFFF', '#ADFF2F'];
            const container = document.body;

            for (let i = 0; i < 24; i++) { // å¢åŠ ç²’å­é‡ï¼Œæ›´æ˜¾éœ‡æ’¼
                const p = document.createElement('div');
                p.className = 'particle';
                const size = 5 + Math.random() * 5;
                p.style.width = size + 'px';
                p.style.height = size + 'px';
                const color = colors[Math.floor(Math.random() * colors.length)];
                p.style.backgroundColor = color;
                p.style.color = color; // box-shadow ä½¿ç”¨ currentColor
                p.style.left = x + 'px';
                p.style.top = y + 'px';

                const angle = Math.random() * Math.PI * 2;
                const velocity = 10 + Math.random() * 20;
                // æ˜¾è‘—æ‹‰å¤§æ‰©æ•£åŠå¾„
                const tx = Math.cos(angle) * velocity * 25;
                const ty = Math.sin(angle) * velocity * 25;

                p.style.setProperty('--tx', `${tx}px`);
                p.style.setProperty('--ty', `${ty}px`);
                // åŠ¨ç”»æ—¶é•¿æ‹‰é•¿è‡³ 2.5sï¼Œå‘ˆç°ä¼˜é›…æ…¢å 
                p.style.animation = `stardust-drift 2.5s cubic-bezier(0.1, 0.8, 0.2, 1) forwards`;

                container.appendChild(p);
                setTimeout(() => p.remove(), 2500);
            }
        }

        function onPropShift() {
            if (slotCards.length === 0) return;
            // é™åˆ¶ç§»å‡ºåŒºæœ€å¤š3å¼ å¡ç‰‡
            if (shiftCards.length >= 3) return;

            // ç§»å‡ºå‰ 3 å¼  (æˆ–å°‘äº 3 å¼ )ï¼Œä½†ä¸èƒ½è¶…è¿‡å‰©ä½™å®¹é‡
            const remainingCapacity = 3 - shiftCards.length;
            const count = Math.min(3, slotCards.length, remainingCapacity);
            if (count <= 0) return;

            const cardsToShift = slotCards.splice(0, count);

            const holder = document.getElementById('shift-holder');

            cardsToShift.forEach(c => {
                shiftCards.push(c);
                c.state = 'shifted';
                c.el.classList.remove('in-slot'); // ç§»é™¤æ§½ä½æ ·å¼

                holder.appendChild(c.el);

                // å…³é”®ä¿®æ­£ï¼šé‡ç½®å¡ç‰‡æ ·å¼ä»¥é€‚åº”ç§»å‡ºåŒº Flex å¸ƒå±€
                c.el.style.position = 'static';
                c.el.style.left = '';
                c.el.style.top = '';
                c.el.style.zIndex = 'auto';
                c.el.style.transform = 'scale(1)'; // ä¸æ¸¸æˆåŒºå¡ç‰‡å¤§å°ä¸€è‡´
                c.el.style.margin = '0 2px';
            });

            playSound('click');
            updateSlotUI();

            // ç§»å‡ºåç«‹å³æ£€æŸ¥æ˜¯å¦å¯ä»¥æ¶ˆé™¤
            checkMatch();
        }

        function onPropUndo() {
            if (moveHistory.length === 0) return;
            const lastMove = moveHistory.pop();
            const card = lastMove.card;

            // åªæœ‰å½“å¡ç‰‡è¿˜åœ¨æ§½ä½ä¸­æ—¶æ‰èƒ½æ’¤å›ï¼ˆè‹¥å·²æ¶ˆé™¤åˆ™æ— æ³•æ’¤å›ï¼Œé€»è¾‘ä¸Šå·²å¤„ç†ï¼‰
            if (card.state !== 'slot') return;

            // 1. ä»æ§½ä½ç§»é™¤
            const idx = slotCards.indexOf(card);
            if (idx > -1) slotCards.splice(idx, 1);

            // 2. æ¢å¤è§†è§‰çŠ¶æ€
            card.state = 'stage';
            card.el.classList.remove('in-slot');

            // å…³é”®ä¿®å¤ï¼šå¿…é¡»è¦æŠŠ DOM ç§»å› game-stageï¼Œå¦åˆ™åæ ‡ç³»ä¸å¯¹
            stage.appendChild(card.el);

            // å¼ºåˆ¶é‡ç»˜ä»¥ç¡®ä¿ transition ç”Ÿæ•ˆï¼ˆå¯é€‰ï¼Œä½†é€šå¸¸ç›´æ¥è®¾ç½® left/top å³å¯ï¼‰
            card.el.style.position = 'absolute';
            card.el.style.left = lastMove.fromX + 'px';
            card.el.style.top = lastMove.fromY + 'px';
            card.el.style.zIndex = lastMove.fromZ;
            card.el.style.transform = ''; // æ¸…é™¤ç¼©æ”¾

            playSound('click'); // æ’­æ”¾éŸ³æ•ˆ

            updateSlotUI();
            checkCover();
        }

        function onPropShuffle() {
            // æ´—ç‰Œï¼šé‡æ’åœºä¸Šå¡ç‰‡åŒºå’Œå †å åŒºçš„å¡ç‰‡ï¼ˆä¸åŒ…æ‹¬ä¸´æ—¶åŒºå’Œå¡æ§½åŒºï¼‰
            // è­¦å‘Šï¼šæ´—ç‰Œä¼šæ”¹å˜å¡ç‰‡ä½ç½®ï¼Œå¯¼è‡´å¦‚æœä¸ç«‹å³æ’¤å›ï¼Œä¹‹å‰çš„æ’¤å›å†å²å¯èƒ½é€šè¿‡åæ ‡è¿˜åŸåˆ°é”™è¯¯ä½ç½®ï¼ˆå› ä¸ºä½ç½®è¢«åˆ«äººå äº†ï¼‰
            // ä¸ºäº†é€»è¾‘ä¸¥è°¨ï¼Œæ´—ç‰Œååº”è¯¥æ¸…ç©ºæ’¤å›å†å²ï¼Œæˆ–è€…æ¥å—"æ’¤å›åˆ°åŸåæ ‡ä½†è§†è§‰é‡å "çš„ç»“æœ
            // è¿™é‡Œé€‰æ‹©æ¸…ç©ºå†å²ï¼Œé¿å…æ··æ·†
            moveHistory = [];

            // æ”¶é›†å¡ç‰‡åŒºå’Œå †å åŒºçš„å¡ç‰‡
            const stageCards = allCards.filter(c => c.state === 'stage' || c.state === 'side-stack');
            if (stageCards.length === 0) return;

            // åˆ†ç¦»å¡ç‰‡åŒºå’Œå †å åŒºçš„å¡ç‰‡
            const areaCards = stageCards.filter(c => c.state === 'stage');
            const stackCards = stageCards.filter(c => c.state === 'side-stack');

            // æ‰“ä¹±å¡ç‰‡åŒºå¡ç‰‡çš„ä½ç½®
            if (areaCards.length > 0) {
                const positions = areaCards.map(c => ({ x: c.x, y: c.y, z: c.z }));
                positions.sort(() => Math.random() - 0.5);
                areaCards.forEach((c, i) => {
                    const pos = positions[i];
                    c.x = pos.x;
                    c.y = pos.y;
                    c.z = pos.z;
                    c.el.style.left = pos.x + 'px';
                    c.el.style.top = pos.y + 'px';
                    c.el.style.zIndex = pos.z;
                });
            }

            // æ‰“ä¹±å †å åŒºå¡ç‰‡ï¼šæ¸…ç©ºåé‡æ–°åˆ›å»ºï¼Œä¿æŒæ ·å¼ä¸€è‡´
            if (stackCards.length > 0) {
                // åˆ†ç¦»å·¦å³å †å åŒºçš„å¡ç‰‡
                const leftStackCards = stackCards.filter(c => {
                    const container = c.el.parentElement;
                    return container && container.id === 'side-stack-left';
                });
                const rightStackCards = stackCards.filter(c => {
                    const container = c.el.parentElement;
                    return container && container.id === 'side-stack-right';
                });

                // å¤„ç†å·¦ä¾§å †å åŒº
                if (leftStackCards.length > 0) {
                    const leftContainer = document.getElementById('side-stack-left');
                    const icons = leftStackCards.map(c => c.icon);
                    // ä» allCards ä¸­ç§»é™¤æ—§çš„å †å åŒºå¡ç‰‡
                    leftStackCards.forEach(c => {
                        const idx = allCards.indexOf(c);
                        if (idx > -1) allCards.splice(idx, 1);
                    });
                    // æ¸…ç©ºå®¹å™¨
                    leftContainer.innerHTML = '';
                    // æ‰“ä¹±å›¾æ ‡é¡ºåº
                    icons.sort(() => Math.random() - 0.5);
                    // é‡æ–°åˆ›å»ºå¡ç‰‡ï¼ˆä½¿ç”¨åŸæœ‰çš„åç§»é€»è¾‘ï¼‰
                    const sideStackCount = icons.length;
                    icons.forEach((icon, i) => {
                        const offsetX = -(sideStackCount - 1 - i) * 6;
                        createCard(icon, offsetX, 0, 600 + i, leftContainer, i);
                    });
                }

                // å¤„ç†å³ä¾§å †å åŒº
                if (rightStackCards.length > 0) {
                    const rightContainer = document.getElementById('side-stack-right');
                    const icons = rightStackCards.map(c => c.icon);
                    // ä» allCards ä¸­ç§»é™¤æ—§çš„å †å åŒºå¡ç‰‡
                    rightStackCards.forEach(c => {
                        const idx = allCards.indexOf(c);
                        if (idx > -1) allCards.splice(idx, 1);
                    });
                    // æ¸…ç©ºå®¹å™¨
                    rightContainer.innerHTML = '';
                    // æ‰“ä¹±å›¾æ ‡é¡ºåº
                    icons.sort(() => Math.random() - 0.5);
                    // é‡æ–°åˆ›å»ºå¡ç‰‡ï¼ˆä½¿ç”¨åŸæœ‰çš„åç§»é€»è¾‘ï¼‰
                    const sideStackCount = icons.length;
                    icons.forEach((icon, i) => {
                        const offsetX = (sideStackCount - 1 - i) * 6;
                        createCard(icon, offsetX, 0, 600 + i, rightContainer, i);
                    });
                }
            }

            playSound('click');
            checkCover();

            // è§†è§‰åé¦ˆï¼šç®€å•çš„æ—‹è½¬åŠ¨ç”»
            stageCards.forEach(c => {
                c.el.style.transition = 'transform 0.5s';
                c.el.style.transform = 'scale(1.1)';
                setTimeout(() => c.el.style.transform = '', 500);
            });
        }

        function resetGameToLevel1() {
            gameState = 'playing';
            document.getElementById('fail-panel').style.display = 'none';
            document.getElementById('win-panel').style.display = 'none';
            slotCards = [];
            shiftCards = []; // é‡ç½®ç§»å‡ºæ ˆ
            slotContainer.innerHTML = '';
            // æ¸…ç©ºç§»å‡ºåŒº
            document.getElementById('shift-holder').innerHTML = '';
            initLevel(1);
        }
    </script>
</body>

</html>