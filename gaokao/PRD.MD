# 阳光高考网招生章程数据爬取项目 PRD

> **项目状态**: ✅ 已完成
> **完成时间**: 2026-01-11
> **最终交付物**: `招生章程.xlsx`（2915所学校的完整信息）
>
> **说明**: 本文档记录了阳光高考网数据爬取项目的完整开发过程、技术方案和经验总结。虽然项目已完成，但本文档保留的开发经验对于后续类似的数据处理项目具有重要的参考价值。

## 项目概述
从阳光高考网（gaokao.chsi.com.cn）爬取所有高校的招生章程数据，生成Excel文件。

---

## 核心技术要求

### 工具选择（关键约束）
- **仅使用 Playwright MCP**（`mcp__playwright__*` 系列工具）
- **严格禁止 Chrome DevTools MCP**（会被反爬虫识别，导致数据不完整）

### 数据字段（9个必填字段）
| 字段 | 说明 | 验证规则 |
|------|------|----------|
| 学校名称 | 高校全称 | 不能为空 |
| 省份 | 所属省份 | 不能为空 |
| 城市 | 直辖市=省份，其他可为空 | - |
| 主管部门 | 教育部/省教育厅等 | 不能为空 |
| 办学层次 | 本科 或 高职(专科) | 必须是二者之一 |
| 院校特性 | "双一流"/民办/独立学院等 | 可为空 |
| 校徽 | 图片地址 | 不能为空，格式：`https://t1.chei.com.cn/common/xh/xxxxx.jpg` |
| 招生章程链接 | 点击"招生章程>"的链接 | 不能为空 |
| 学校详情页链接 | 点击学校名称的链接 | 不能为空 |

---

## 爬取流程

### 第一页：初始加载
1. 打开第一页URL
2. 等待页面完全加载（网络空闲 + 图片加载完成）
3. 确认校徽图片数量充足（>90张）
4. 提取数据
5. 验证数据
6. 追加写入Excel

### 后续页：翻页爬取
1. **填写页码翻页**（推荐方式）
   - 直接在页码输入框中填写目标页码
   - 按Enter键或点击"跳转"按钮进行翻页
   - **不要使用"下一页"按钮**：实际爬取中发现点击"下一页"按钮多次导致翻页失败
   - 直接填写页码更可靠，能确保准确跳转到目标页面
2. 等待条件比第一页更严格（图片懒加载需要更长时间）
3. 快照确认页面状态
4. 提取数据
5. **立即验证数据**（发现异常立即停止）
6. 追加写入Excel

### 等待策略（经验教训）
**关键问题**: 后续页面的校徽变成 `default.jpg`

**原因分析**:
- 第一页：用户主动打开，浏览器触发图片加载，校徽正确
- 后续页：点击翻页后，图片可能还在视口外，懒加载未完成，src仍是默认值

**解决方案**:
- 提取前确认图片已加载（检查图片数量和src是否包含default.jpg）
- 使用动态等待而非固定时间（等待条件满足而非等待N秒）
- 后续页等待时间应比第一页更长（3-5秒）

---

## 数据验证

### 验证时机
**每页提取后立即验证，发现问题立即停止爬取**

不要等到最后才发现问题，这样会导致大量重复工作。

### 验证清单
每页数据必须通过以下检查：

1. **数据条数检查**
   - 前29页：每页100条
   - 第30页：15条
   - 发现条数不对立即停止

2. **必填字段检查**
   - 学校名称不能为空
   - 主管部门不能为空
   - 办学层次必须是"本科"或"高职(专科)"
   - 所有链接格式必须正确（以https://开头）

3. **校徽检查（关键指标）**
   - default.jpg 的占比应该 < 10%
   - 如果占比过高（如超过30%），说明图片未加载完成
   - 此时应增加等待时间或检查网络连接

4. **数据一致性检查**
   - 当前页的URL与期望页码一致
   - 不是重复上一页的数据

### 验证失败的处理
当验证失败时：
1. 立即停止爬取
2. 输出详细的错误信息
3. 给出具体的解决建议（如增加等待时间、检查网络等）
4. 不要跳过错误继续爬取

---

## 状态管理

### Compaction后的状态恢复
**问题**: compaction后会丢失浏览器会话信息，导致打开空白浏览器循环

**预防措施**:
1. 每次操作前检查现有标签页（使用browser_tabs）
2. 使用快照确认页面状态（使用browser_snapshot）
3. 如果发现页面异常，重新导航到正确URL

### 每次操作前的状态检查
- 确认浏览器会话正常
- 确认在正确页面
- 确认"下一页"按钮存在（未到最后一页）

---

## 性能优化

### 性能问题分析
| 问题 | 耗时占比 | 说明 |
|------|---------|------|
| 工具选择错误 | 30% | 使用Chrome DevTools导致失败和重试 |
| 重复爬取 | 20% | 数据错误需要重新爬取 |
| 过度延迟 | 20% | 固定等待时间过长 |
| 上下文恢复 | 15% | compaction后重新读取状态 |
| 低效提取 | 15% | JavaScript执行不够优化 |

### 优化策略

**1. 动态等待而非固定延迟**
- 等待特定条件满足（如图片加载完成）
- 而非固定等待N秒
- 这样可以减少等待时间，同时确保数据完整

**2. 增量写入而非批量写入**
- 每页提取后立即追加到Excel
- 不要在内存中积累所有数据
- 避免内存占用过大和上下文膨胀

**3. 中间数据存文件**
- 临时数据保存到 /tmp 目录
- 不要加载到对话上下文
- 减少compaction频率

**4. 只验证当前页**
- 只验证新增的数据
- 不要每次都读取整个Excel文件
- 减少I/O操作和上下文累积

---

## 反爬虫对策

### 1. 随机延迟
每页之间设置2-5秒的随机延迟，模拟人类操作。

### 2. 模拟人类操作
- 使用点击按钮而非直接修改URL
- 偶尔滚动页面
- 避免过于规律的操作模式

### 3. 错误重试机制
- 遇到错误等待后重试
- 最多重试3次
- 超过次数则停止并报告

---

## 常见问题和解决方案

### 问题1：校徽全部变成default.jpg
**原因**: 图片懒加载未完成，提取时img.src还是默认值

**解决方案**:
- 增加等待时间（3-5秒）
- 在提取前检查图片数量和src状态
- 使用waitForFunction等待图片加载完成

### 问题2：打开空白浏览器循环
**原因**: compaction后丢失浏览器会话，重复打开新标签页

**解决方案**:
- 每次操作前使用browser_tabs检查现有标签
- 使用browser_snapshot确认页面状态
- 不要假设浏览器状态

### 问题3：数据条数不对
**原因**: 页面未完全加载或提取逻辑有缺陷

**解决方案**:
- 增加等待时间
- 检查页面结构是否变化
- 验证提取逻辑

### 问题4：点击"下一页"按钮导致翻页失败
**原因**: 点击"下一页"按钮不可靠，多次爬取中出现翻页错误

**解决方案**:
- 直接在页码输入框中填写目标页码
- 按Enter键或点击"跳转"按钮进行翻页
- 避免使用"下一页"按钮，优先使用直接页码输入

### 问题5：频繁compaction导致上下文丢失
**原因**: 对话历史和中间数据累积过多

**解决方案**:
- 中间数据保存到文件，不放在上下文
- 减少大文件的重复读取
- 每页只验证新增数据，不重新验证全部

---

## 输出文件

| 文件名 | 说明 | 数量 |
|--------|------|------|
| 招生章程.xlsx | 最终数据（2915所学校的完整信息） | 2915 所 |
| 2025全国普通高等学校名单.xlsx | 教育部官方名单（参考数据源） | 2919 所 |

### 数据处理脚本

| 文件名 | 说明 |
|--------|------|
| crawl_gaokao_schools.py | 阳光高考网爬虫，获取学校基础信息 |
| fill_features_by_tags.py | 基于筛选标签补充院校特性数据（820所） |
| fill_city_data.py | 从教育部名单匹配城市数据（2652所） |
| fill_47_cities.py | 补充47所匹配失败院校的城市信息 |
| add_remarks.py | 添加备注列，标注匹配失败原因 |

---

## 开发检查清单

### 爬取前
- 确认使用 Playwright MCP（不用 Chrome DevTools）
- 确认浏览器会话正常
- 确认网络连接正常

### 爬取中（每页）
- 数据条数正确（前29页100条，第30页15条）
- 学校名称全部非空
- 校徽中 default.jpg 占比 < 10%
- 所有链接格式正确
- 数据已追加写入Excel

### 爬取后
- Excel文件行数 = 预期学校数（2915）
- 双一流学校数量 ≈ 147所（对比参考名单）
- 抽查10条数据，确认字段完整

---

## 核心经验总结

1. **数据质量 > 速度**: 先确保正确，再优化性能
2. **状态检查**: 每次操作前检查当前状态，不假设
3. **增量验证**: 只验证新增数据，不重新验证全部
4. **及时发现问题**: 每页立即验证，不要等到最后
5. **动态等待**: 等待条件满足而非固定时间
