# 阳光高考网招生章程数据技术文档

## 一、项目架构

### 1.1 总体架构

```
┌────────────────────────────────────────────────────────────┐
│                        数据源                              │
│           阳光高考网 (gaokao.chsi.com.cn)                  │
└────────────────────┬───────────────────────────────────────┘
                     │
                     v
┌────────────────────────────────────────────────────────────┐
│                    爬虫层 (modules/)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ crawler  │→│extractor │→│ cleaner  │→│ storage  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└────────────────────┬───────────────────────────────────────┘
                     │
                     v
┌────────────────────────────────────────────────────────────┐
│                   数据处理层 (scripts/)                    │
│  基础数据爬取 → 详情链接爬取 → 章程内容爬取 → 数据合并      │
└────────────────────┬───────────────────────────────────────┘
                     │
                     v
┌────────────────────────────────────────────────────────────┐
│                   数据存储层 (achievement/)                │
│           招生章程.xlsx      招生章程（详情）.xlsx          │
└────────────────────────────────────────────────────────────┘
```

### 1.2 目录结构

```
gaokao/
├── prd.md                    # 产品需求文档
├── tech.md                   # 技术文档（本文件）
├── scripts/                  # 可执行脚本
│   ├── crawl_*.py           # 爬取脚本
│   ├── fill_*.py            # 数据填充脚本
│   └── merge_*.py           # 数据合并脚本
├── modules/                  # 可复用模块
│   ├── crawler.py           # 浏览器自动化
│   ├── extractor.py         # 内容提取
│   ├── cleaner.py           # 数据清理
│   ├── storage.py           # 文件存储
│   └── progress.py          # 进度管理
├── details/                  # 纯文本章程（2115所）
├── tables/                   # 表格章程（800所）
├── special/                  # 特殊章程（3所）
└── achievement/              # 最终数据文件
```

### 1.3 数据流设计

```
1. 基础数据采集
   crawl_gaokao_schools.py → 2915所学校基础信息
   ├─ fill_features_by_tags.py → 补充院校特性
   ├─ fill_city_data.py → 匹配城市数据
   └─ fill_47_cities.py → 补充剩余城市

2. 详情链接采集
   crawl_enrollment_details.py → 招生章程详情页链接

3. 章程内容采集
   ├─ crawl_regulations.py → 纯文本章程（2115所）
   ├─ crawl_with_tables.py → 表格章程（800所）
   └─ crawl_special_regulations.py → 特殊章程（3所）

4. 数据合并
   merge_regulations_to_excel.py → 合并到Excel
   add_special_column.py → 添加特殊章程列
```

---

## 二、核心技术栈

### 2.1 爬虫框架

| 技术 | 版本 | 用途 |
|------|------|------|
| Playwright | latest | 浏览器自动化 |
| Python | 3.x | 主要编程语言 |
| openpyxl | latest | Excel文件操作（保留格式） |
| pandas | latest | 数据处理和分析 |

### 2.1.1 工具选择决策

**本地 Playwright vs MCP 工具**：

| 对比维度 | 本地 Playwright 脚本 | MCP 工具（playwright MCP） |
|---------|---------------------|---------------------------|
| 成本 | 不消耗 Token | 消耗 Token |
| 适用场景 | 批量处理、自动化任务（2915条全量验证） | 交互式操作、一次性任务（单条数据测试） |
| 调试便利性 | 可直接调试打印 | 需要通过对话查看结果 |
| 断点续传 | 容易实现（JSON 进度文件） | 难以实现 |
| 推荐场景 | 批量爬取、验证任务 | 快速测试、探索性任务 |

**结论**：
- 批量爬取/验证：优先使用本地 Python 脚本
- 单条测试/探索：使用 MCP 工具快速验证

### 2.2 反爬虫配置

```python
browser = await p.chromium.launch(
    headless=False,  # 有头模式更稳定
    args=['--disable-blink-features=AutomationControlled']
)

context = await browser.new_context(
    user_agent='Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
    viewport={'width': 1920, 'height': 1080},
    locale='zh-CN',
    timezone_id='Asia/Shanghai',
)
```

**必须包含的配置（缺一不可）**：

| 配置项 | 说明 | 缺失后果 |
|--------|------|----------|
| `--disable-blink-features=AutomationControlled` | 禁用自动化检测（核心参数） | 会被反爬虫识别，返回 HTTP 412 |
| `user_agent` | 完整的浏览器指纹 | 不完整会被识别为爬虫 |
| `viewport` | 标准桌面分辨率（1920x1080） | 默认视口大小异常 |
| `locale='zh-CN'` | 匹配中国用户语言 | 与实际访问者不符 |
| `timezone_id='Asia/Shanghai'` | 匹配中国时区 | 与实际访问者不符 |
| `headless=False` | 有头模式 | 无头模式更容易被检测 |

**常见错误**：
- ❌ 简化配置（如省略 locale 或 timezone_id）
- ❌ 使用 headless=True
- ❌ 缩短延迟时间追求速度
- ❌ 复用代码时遗漏关键配置

### 2.3 延迟策略

| 场景 | 延迟时间 | 说明 |
|------|---------|------|
| 第一页 | 2秒 | 确保页面完全加载 |
| 后续页面 | 0.5秒 | 快速切换 |
| 学校之间 | 0.3-0.5秒 | 避免过快请求 |
| 批次之间 | 2秒 | 短暂休息 |

**效果**：800所学校，30分钟完成，100%成功率

---

## 三、内容提取技术

### 3.1 纯文本提取（details/）

**提取逻辑**：
```javascript
// 获取页面纯文本
let text = document.body.innerText;

// 定位开始和结束标记
let lines = text.split('\n');
let startIdx = lines.findIndex(line => line.includes('已经由上级主管部门审核通过'));
let endIdx = lines.findIndex(line => line.includes('学籍查询'));

// 提取中间内容
let content = lines.slice(startIdx + 1, endIdx)
    .map(line => line.trim())
    .filter(line => line)
    .join('\n\n');
```

### 3.2 表格提取（tables/）

**核心原则**：简单直接优于复杂实现

**提取逻辑**：
```javascript
// 直接使用字符串substring，而非DOM遍历
let bodyHTML = document.body.innerHTML;
let startIdx = bodyHTML.indexOf('已经由上级主管部门审核通过');
let endIdx = bodyHTML.indexOf('学籍查询', startIdx);
let contentHTML = bodyHTML.substring(startIdx + startMarker.length, endIdx);
```

**表格清理策略**：

| 清理项 | 操作 | 保留 |
|--------|------|------|
| table 属性 | 全部移除 | - |
| tr 属性 | 全部移除 | - |
| td/th 属性 | 全部移除 | colspan, rowspan |
| 单元格内容 | 提取文本 + 换行符 | - |

**效果**：文件体积减少93%（76,826 → 5,542字符）

---

## 四、多链接处理技术

### 4.1 问题背景

招生章程与学校之间存在的复杂关系：**一对多**和**多对一**。

#### 4.1.1 一对多关系（一个学校名称 → 多个章程链接）

**情况1：重复发布（3所）**
- 可能原因：误操作、系统问题、重复提交
- 特征：内容完全相同（0字符差异）
- 处理：任选一个，通常取infoId较大的
- 示例：大连理工大学城市学院、大连科技学院、辽宁理工学院

**情况2：修订版本（5所）**
- 可能原因：格式修正、错别字更正、内容微调
- 特征：存在轻微差异（1-393字符）
- 处理：取infoId较大的版本（新版本）
- 示例：
  - 江苏理工学院（1字符）- 格式修正（顿号）
  - 西双版纳职业技术学院（3字符）- 格式调整
  - 喀什理工职业技术学院（8字符）- 内容精简
  - 娄底幼儿师范高等专科学校（23字符）- 内容修订
  - 大连医科大学中山学院（393字符）- 格式优化

**情况3：特殊类型（3所）**
- 可能原因：分校、特殊学院有独立招生章程
- 特征：内容完全不同，属于特殊类型
- 处理：单独爬取，存入"特殊"列
- 示例：
  - 首都经济贸易大学（密云分校）
  - 浙江工商大学（人民武装学院）
  - 西南林业大学（艺术、体育类）

#### 4.1.2 多对一关系（多个独立入口 → 共用/独立章程）

**背景**：教育部的一个学校名称，在阳光高考网上可能有多个独立发布招生章程的入口。

**独立入口类型**：
1. **分校区**（17所）- 如哈尔滨工业大学(威海)、(深圳)
2. **医学院**（4所）- 如上海交通大学医学院
3. **中外合作办学**（12所）

**章程发布情况**：
- **情况A**：独立发布自己的招生章程
  - 大部分分校区/医学院会独立发布
  - 内容与主校区类似，但针对该校区/学院具体化

- **情况B**：沿用主校区章程
  - 部分分校区/中外合作项目没有独立章程
  - 招生章程详情页链接为空或指向主校区

**处理策略**：
```python
# 按独立招生代码单位处理
# 每个分校区/医学院作为独立条目
if 分校区有独立章程:
    使用该分校区章程
else:
    章程字段为空（或标记为"沿用主校区"）
```

#### 4.1.3 实际案例分析

**案例1：哈尔滨工业大学（一主二分校）**
```
教育部名单：1个条目（哈尔滨工业大学）
阳光高考网：3个条目
  - 哈尔滨工业大学
  - 哈尔滨工业大学(威海)
  - 哈尔滨工业大学(深圳)
处理：各自作为独立条目，分别爬取章程
```

**案例2：首都经济贸易大学（一主一特殊）**
```
阳光高考网：2个章程链接
  - 首都经济贸易大学2025年招生章程（主校）
  - 首都经济贸易大学密云分校2025年招生章程（特殊）
处理：主校章程存入主列，特殊章程存入"特殊"列
```

**案例3：双一流院校统计差异**
```
教育部名单：约147所主校
阳光高考网：164条记录
差异原因：
  - 分校区（17所）：独立招生代码
  - 医学院（4所）：独立招生代码
  - 中外合作（若干）：独立招生代码
结论：一个"学校名称"对应多个"招生条目"
```

### 4.2 对比分析结果

对8所学校（排除3所真正特殊的）的两个链接进行内容对比：

| 学校 | 差异 | 类型 | 处理方式 |
|------|------|------|----------|
| 大连理工大学城市学院 | 0字符 | 完全相同 | 任一版本 |
| 大连科技学院 | 0字符 | 完全相同 | 任一版本 |
| 辽宁理工学院 | 0字符 | 完全相同 | 任一版本 |
| 江苏理工学院 | 1字符 | 格式修正（顿号） | 取 infoId 大的 |
| 西双版纳职业技术学院 | 3字符 | 格式调整 | 取 infoId 大的 |
| 喀什理工职业技术学院 | 8字符 | 内容精简 | 取 infoId 大的 |
| 娄底幼儿师范高等专科学校 | 23字符 | 内容修订 | 取 infoId 大的 |
| 大连医科大学中山学院 | 393字符 | 格式优化 | 取 infoId 大的 |

### 4.3 核心发现

1. **重复发布常见**：3所学校完全相同，可能是误操作
2. **修订版本质量更高**：5所学校存在差异，新版本格式更规范
3. **没有实质性内容删除**：所有差异都是格式或轻微修订
4. **infoId作为版本指示器**：infoId越大表示版本越新

### 4.4 处理策略

#### 策略1：一对多（同一学校多个版本）
```
取 infoId 更大的版本（时间更靠后的版本）
- 新版本通常是学校修订后的版本
- 格式更规范、错别字更少
- 内容上没有发现重要信息删除的情况
```

#### 策略2：特殊类型单独处理
```
真正特殊的3所学校：
- 首都经济贸易大学（密云分校）
- 浙江工商大学（人民武装学院）
- 西南林业大学（艺术、体育类）

处理方式：
1. 单独爬取特殊章程
2. 保存到 special/ 文件夹
3. 添加到 Excel 的"招生章程内容（特殊）"列
```

#### 策略3：多对一（分校区/医学院）
```
按独立招生代码单位处理：
- 每个分校区/医学院作为独立条目
- 各自爬取自己的章程
- 如无独立章程，则字段为空
```

### 4.5 业务理解要点

**为什么会出现这些复杂关系？**

1. **独立招生代码**：分校区、医学院、中外合作办学有独立的招生代码，在阳光高考网以独立条目显示

2. **章程发布自主性**：每个独立招生单位可以自主决定是否发布独立章程，有的发布，有的沿用主校区

3. **重复发布现象**：同一学校可能因为误操作、系统问题、重复提交导致多个相同版本的章程

4. **版本迭代习惯**：学校在招生季可能会修订章程（格式修正、错别字更正），发布新版本但保留旧版本

**如何识别和处理？**

- 识别关键特征：特殊类型名称（密云分校、人民武装学院、艺术体育）
- 对比内容差异：0字符=重复，小差异=修订，大差异=特殊类型
- 使用infoId判断：infoId越大表示版本越新
- 特殊情况单独处理：特殊类型章程单独爬取和存储

**业务影响**：

| 现象 | 影响 | 应对 |
|------|------|------|
| 重复发布 | 数据冗余 | 任选其一（取infoId大的） |
| 修订版本 | 质量提升 | 取新版本（格式更规范） |
| 特殊类型 | 需单独存储 | 单独爬取，存入特殊列 |
| 分校区独立 | 数据条目增多 | 按独立条目处理 |

---

## 五、Excel数据合并

### 5.1 合并策略
1. 800所学校优先使用 `tables/` 文件夹的HTML表格格式
2. 2115所学校使用 `details/` 文件夹的纯文本格式
3. 88所学校无链接，内容为空

### 5.2 新增列
- **招生章程内容**：章程全文（HTML或纯文本）
- **招生章程是否含表格**：是/否标识（800所是，2115所否）
- **招生章程内容（特殊）**：仅3所特殊学校

### 5.3 技术要点
- 使用 `openpyxl` 保持原有格式和样式
- 直接在Excel中新增列，避免重新创建文件
- 使用 `pd.notna()` 判断内容是否为空

---

## 六、关键经验总结

### 6.1 数据质量优先原则

1. **数据质量 > 速度**：先确保正确，再优化性能
2. **状态检查**：每次操作前检查当前状态，不假设
3. **增量验证**：只验证新增数据，不重新验证全部
4. **及时发现问题**：每页立即验证，不要等到最后
5. **动态等待**：等待条件满足而非固定时间

### 6.2 简单逻辑优于复杂实现
- 字符串 `substring` 比节点遍历更可靠
- 直接操作 `innerHTML` 比复杂 DOM API 更易维护
- 复用已验证的代码模式

### 6.3 表格属性清理很重要
- 表格属性冗余会导致文件过大
- 清理后文件体积减少93%
- 必须保留 `colspan/rowspan` 维护表格结构

### 6.4 速度优化要适度
- 第一页2秒，后续0.5秒
- 不能盲目追求速度导致被反爬虫拦截
- 总耗时与成功率要平衡

### 6.5 多链接取新版本
- infoId越大表示版本越新
- 新版本通常是修订后的版本，质量更好
- 差异主要是格式优化，实质性内容变化很小

### 6.6 headless=False 更稳定
- 有头模式更不容易被反爬虫检测
- 便于调试和验证
- headless模式可能获取不到内容

### 6.7 复用已验证的代码
- 不要每次都重新写简化版
- 已验证的代码包含所有必要的反爬虫配置
- 代码复用比"看起来差不多"更可靠

---

## 七、数据统计分析

### 7.1 双一流高校统计

| 类型 | 数量 | 说明 |
|------|------|------|
| 分校区 | 17所 | 拥有独立招生代码的分校校区 |
| 医学院 | 4所 | 独立招生的医学院 |
| 双一流主校 | 143所 | 去除特殊类型后的主校数量 |
| **双一流总条目数** | **164所** | Excel中标记为双一流的总行数 |

**分校区详细列表**：
- 中国地质大学(北京)、中国地质大学(武汉)
- 中国石油大学(北京)、中国石油大学(北京)克拉玛依校区、中国石油大学(华东)
- 中国矿业大学(北京)
- 北京交通大学(威海校区)、北京师范大学(珠海校区)、北京邮电大学(宏福校区)
- 华北电力大学(保定)、华北电力大学(北京)
- 合肥工业大学(宣城校区)
- 哈尔滨工业大学(威海)、哈尔滨工业大学(深圳)
- 大连理工大学(盘锦校区)
- 电子科技大学(沙河校区)
- 西南大学(荣昌校区)

**医学院详细列表**：
- 上海交通大学医学院
- 北京协和医学院
- 复旦大学医学院
- 浙江大学医学院

### 7.2 院校特性分布

| 院校特性 | 学校数量 | 占比 | 说明 |
|---------|---------|------|------|
| 公办高校 | 1931所 | 66.2% | 院校特性列为空（正常） |
| 民办高校 | 665所 | 22.8% | 新增标注 |
| "双一流"建设高校 | 164所 | 5.6% | 原有数据，保持不变 |
| 独立学院 | 139所 | 4.8% | 新增标注 |
| 中外合作办学 | 12所 | 0.4% | 新增标注 |
| 内地与港澳台地区合作办学 | 4所 | 0.1% | 新增标注 |

### 7.3 章程类型分布

| 类型 | 数量 | 占比 | 存储位置 |
|------|------|------|----------|
| 含表格章程 | 800所 | 27.5% | tables/ |
| 纯文本章程 | 2115所 | 72.5% | details/ |
| 特殊章程 | 3所 | 0.1% | special/ |
| 无内容 | 88所 | 3.0% | - |

### 7.4 省份分布（含表格800所）

TOP 10 省份：
1. 河南 - 173所（21.6%）
2. 湖南 - 134所（16.8%）
3. 浙江 - 106所（13.2%）
4. 辽宁 - 94所（11.8%）
5. 上海 - 56所（7.0%）
6. 江西 - 40所（5.0%）
7. 山西 - 37所（4.6%）
8. 安徽 - 25所（3.1%）
9. 广西 - 21所（2.6%）
10. 福建 - 16所（2.0%）

涉及28个省级行政区

### 7.5 数据差异分析

**教育部名单 vs 阳光高考网**：

| 分类 | 数量 | 说明 |
|------|------|------|
| 两名单共同学校 | 2860所 | 占比97.9% |
| 只在教育部名单中 | 59所 | 已停办/转设/未招生 |
| 只在阳光高考网中 | 55所 | 军事院校/分校/成人教育 |

**差异原因**：
1. 军事院校（19所）- 教育部未纳入，由中央军委单独管理
2. 双一流分校/医学院（19所）- 教育部以主校名义列出，阳光高考网独立显示
3. 已停办/合并院校（37所）- 教育部名单未及时更新
4. 成人教育类院校（9所）- 教育部在成人高校名单中列出
5. 名称变化（7所）- 更名/升格院校两名单不同步

---

## 八、未来技术优化方向

### 8.1 功能优化
1. **断点续传**：支持从中断的位置继续爬取
2. **增量更新**：检测已爬取的学校，只更新有变化的
3. **内容验证**：自动检测内容完整性（如关键字、章节结构）
4. **性能监控**：记录爬取速度、成功率、错误率等指标
5. **日志完善**：结构化日志，便于问题排查

### 8.2 技术改进
1. **异步并发**：使用 asyncio 提高爬取效率
2. **代理池**：支持多IP轮换，降低被封风险
3. **分布式爬取**：支持多机器协同工作
4. **智能重试**：根据错误类型自动调整重试策略
5. **缓存机制**：避免重复爬取相同内容

### 8.3 数据处理
1. **自动识别**：智能识别章程类型和章节结构
2. **格式标准化**：统一不同来源的章程格式
3. **质量评分**：根据完整度、格式规范度给出质量分
4. **变化检测**：自动对比不同版本的差异

---

*最后更新：2026-01-16*
