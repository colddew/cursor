# 招生大本批量处理方案

## 🎯 核心需求

**输入**：500页招生大本（PDF 或 图片）
**输出**：按类别合并的完整表格（Excel）
**流程**：预处理 → OCR识别 → 人工分类 → 合并

---

## 📋 完整工作流程

```
PDF/图片
    ↓
【预处理】PDF切图 or 直接使用图片
    ↓
【OCR识别】并发处理（5-10并发）
    ↓
500个 Markdown + 500个 Excel
    ↓
【人工分类】把同类表格的Excel移动到分类文件夹
    ↓
【合并】每个文件夹合并成一个完整Excel
    ↓
最终数据（可直接使用或导入数据库）
```

---

## Proposed Changes

### 工具1：预处理 + 并发OCR

#### [NEW] [batch_ocr.py](file:///project_root/batch_ocr.py)

**功能**：
- 自动检测输入类型（PDF/图片文件夹）
- PDF自动切成图片
- 并发调用 AI Studio API（可配置并发数）
- 断点续传（已处理的跳过）
- 进度显示

**使用方式**：
```bash
# 处理PDF
./venv/bin/python batch_ocr.py zhejiang.pdf output/

# 处理图片文件夹
./venv/bin/python batch_ocr.py input_images/ output/

# 指定并发数
./venv/bin/python batch_ocr.py input/ output/ --workers 10
```

**输出结构**：
```
output/
├── page_001/
│   ├── page_001_20260121_170000.md
│   └── page_001_20260121_170000.xlsx
├── page_002/
│   └── ...
└── progress.json  # 记录处理进度（支持断点续传）
```

---

### 工具2：Excel合并

#### [NEW] [merge_excel.py](file:///project_root/merge_excel.py)

**功能**：
- 扫描文件夹中的所有 Excel
- 按顺序合并所有表格
- 智能处理表头（只保留第一个）
- 输出合并后的完整 Excel

**使用方式**：
```bash
# 合并某个分类文件夹
./venv/bin/python merge_excel.py category_A/ merged_A.xlsx

# 保留所有表头
./venv/bin/python merge_excel.py category_A/ merged_A.xlsx --keep-headers
```

---

## 📊 预估性能

| 指标        | 单线程 | 10并发     |
| ----------- | ------ | ---------- |
| 单页耗时    | 15秒   | 15秒       |
| 500页总耗时 | 2小时  | **12分钟** |
| API调用     | 顺序   | 并行       |

---

## 🔧 .env 配置更新

```bash
# AI Studio 配置
AISTUDIO_API_URL=你的API地址
AISTUDIO_TOKEN=你的访问令牌

# 批量处理配置
MAX_WORKERS=5  # 并发数（建议5-10）
```

---

## Verification Plan

### 测试步骤

1. **测试 PDF 处理**：
   ```bash
   ./venv/bin/python batch_ocr.py zhejiang.pdf test_output/
   ```
   验证：5页PDF生成5个Markdown+5个Excel

2. **测试断点续传**：
   - 中断处理
   - 重新运行
   - 验证：跳过已处理的文件

3. **测试合并**：
   ```bash
   ./venv/bin/python merge_excel.py test_output/ merged.xlsx
   ```
   验证：合并后的Excel包含所有表格数据

---

## 📝 使用流程示例

### 场景：处理500页浙江招生大本

**第1步：批量OCR**
```bash
./venv/bin/python batch_ocr.py 浙江招生大本.pdf output/浙江/
# 预估耗时：12分钟（10并发）
```

**第2步：人工分类**
```bash
# 手动操作：
# 1. 预览每个Excel
# 2. 把"学校列表"类型的Excel移动到 output/浙江/学校列表/
# 3. 把"专业列表"类型的Excel移动到 output/浙江/专业列表/
```

**第3步：合并**
```bash
./venv/bin/python merge_excel.py output/浙江/学校列表/ 浙江_学校列表.xlsx
./venv/bin/python merge_excel.py output/浙江/专业列表/ 浙江_专业列表.xlsx
```

**最终输出**：
- `浙江_学校列表.xlsx` - 完整的学校列表
- `浙江_专业列表.xlsx` - 完整的专业列表

---

## User Review Required

> [!IMPORTANT]
> **关键设计决策**：
> 1. 并发数默认设为5（避免触发API限流）
> 2. PDF切图使用 PyMuPDF（无需额外安装）
> 3. 人工分类环节无法自动化（不同省份格式差异大）

> [!NOTE]
> 如果你对以上方案有修改意见，请告诉我，我会调整后再实现。
