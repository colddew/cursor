# 性能测试报告

## 📊 三次测试对比

### 测试环境
- **OCR 服务**: AI Studio PaddleOCR-VL API
- **测试数据**: 5页招生大本图片（page_001 ~ page_005）
- **机器配置**: 2015 Intel MacBook
- **网络环境**: 家庭宽带

### 详细数据对比

| 测试批次   | 日期/时间            | 执行模式                | 总耗时                   | 平均耗时/页 | 最快页面              | 最慢页面               | 备注                                     |
| ---------- | -------------------- | ----------------------- | ------------------------ | ----------- | --------------------- | ---------------------- | ---------------------------------------- |
| **第一次** | 之前某次             | 顺序执行                | 196秒<br/>(3.3分钟)      | 39.2秒      | 6.1秒<br/>(page_001)  | 72.0秒<br/>(page_004)  | API 响应快                               |
| **第二次** | 2026-01-21<br/>22:22 | 顺序执行                | 350.6秒<br/>(5.8分钟)    | 70.1秒      | 40.8秒<br/>(page_001) | 178.0秒<br/>(page_002) | API 响应慢                               |
| **第三次** | 2026-01-21<br/>22:42 | **并发5**<br/>间隔500ms | 68.3秒<br/>(1.1分钟)     | 45.8秒      | 11.9秒<br/>(page_005) | 66.7秒<br/>(page_004)  | 浙江（脚本旧）                           |
| **第四次** | 2026-01-22<br/>00:30 | **并发5**<br/>间隔500ms | **46.2秒**<br/>(0.8分钟) | **28.6秒**  | 9.6秒<br/>(page_001)  | 44.7秒<br/>(page_004)  | ⚠️ **安徽旧脚本失效记录**                 |
| **第五次** | 2026-01-22<br/>18:20 | **并发5**<br/>间隔500ms | **46.4秒**<br/>(0.8分钟) | **35.5秒**  | 10.6秒<br/>(page_004) | 46.1秒<br/>(page_003)  | **浙江旧 benchmark**                     |
| **第六次** | 2026-01-24           | **并发5**               | **163.2秒**              | **10.2秒**  | 8.4秒                 | 13.4秒                 | 🏆 **全线大通关：首次达成三路 100% 成功** |

### 各页面耗时详情

| 页面     | 第三次(浙江旧) | 第四次(安徽失效) | 第五次(浙江新) | 复杂度   |
| -------- | -------------- | ---------------- | -------------- | -------- |
| page_001 | 34.9秒         | **9.6秒**        | 37.4秒         | 简单     |
| page_002 | 52.0秒         | **17.6秒**       | 39.6秒         | 中等     |
| page_003 | 63.7秒         | **37.8秒**       | 46.1秒         | 复杂     |
| page_004 | 66.7秒         | **44.7秒**       | 10.6秒         | 非常复杂 |
| page_005 | 11.9秒         | **33.4秒**       | 43.6秒         | 复杂     |

---

## 📈 性能分析

2. **从“部分失效”到“全线合规”**
   - 早期测试（如第四次）中，安徽历史及浙江数据因解析逻辑或路径加载问题存在大量失效记录。
   - **第六次测试结论**：通过同步导入逻辑与参数标准，解决了三路数据的所有阻塞点，首次实现了浙江、安徽物理、安徽历史的**全量、全序、全成功**转换。

3. **并行处理效果显著**
   - 顺序执行耗时: 350.6秒
   - 并发5执行耗时: 68.3秒
   - **加速比**: **5.1倍**

3. **页面复杂度影响不确定**
   - 同一页面在不同测试中耗时差异巨大
   - 说明主要瓶颈在 **API 响应速度**，而非本地处理

### 并发优化效果

**配置**: `MAX_WORKERS=5`, `API_REQUEST_DELAY_MS=500`

**优势**:
- ✅ 5个请求同时进行，充分利用 API 并发能力
- ✅ 500ms 间隔避免触发限流
- ✅ 总耗时接近 max(单页耗时)，而非 sum(单页耗时)

**实际效果**:
- page_002 虽然复杂但并发时只用了 52秒（顺序时 178秒）
- 因为可以和其他页面同时处理

---

## 🔮 分省份分类预估 (并发 5)

根据实测，不同省份的内容复杂度存在差异，故采用不同的基准值进行预估。

### 1. 浙江组 (基准: 8.4秒/页 ⭐ 生产实测)
- **总页数**: 381页
- **实测总耗时**: 41.8秒 (5页样本)
- **预估全量耗时**: (381 × 8.4) ÷ 5 ≈ **640秒**
- **结论**: 约 **11 分钟** (生产级提速)

### 2. 安徽历史组 (基准: 9.1秒/页 ⭐ 生产实测)
- **总页数**: 367页
- **实测总耗时**: 54.6秒 (6页样本)
- **预估全量耗时**: (367 × 9.1) ÷ 5 ≈ **668秒**
- **结论**: 约 **12 分钟** (由失效转为高效)

### 3. 安徽物理组 (基准: 13.4秒/页 ⭐ 生产实测)
- **总页数**: 214页
- **实测总耗时**: 66.8秒 (5页样本)
- **预估全量耗时**: (214 × 13.4) ÷ 5 ≈ **573秒**
- **结论**: 约 **10 分钟** (逻辑最重且最稳)

---

## 📅 项目总体进度表 (全量 962 页)

| 执行批次     | 页数    | 预估时间    | 状态/基准                |
| :----------- | :------ | :---------- | :----------------------- |
| **浙江全量** | 381     | 11 分钟     | ✅ **100% 成功测试**      |
| **安徽历史** | 367     | 12 分钟     | ✅ **100% 成功测试**      |
| **安徽物理** | 214     | 10 分钟     | ✅ **100% 成功测试**      |
| **项目合计** | **962** | **33 分钟** | 🏁 **全线具备一键生产力** |

⚠️ **注意**: 并发数过高可能触发 API 限流，建议不超过 5。

---

## 💾 Excel 文件大小预估

### 基于实测数据

当前5页 Excel 文件大小：
- 平均: 6.8KB/页
- 最小: 5.3KB (page_001)
- 最大: 7.9KB (page_005)

### 浙江 381页 预估

**单文件模式**:
- 大小: 381 × 6.8KB ≈ **2.6MB**
- 性能: ✅ 打开流畅，完全不卡

**多文件模式**:
- 文件数: 381个
- 总大小: 2.6MB
- 单文件大小: 5-8KB

### 安徽 581页 预估

**单文件模式**:
- 大小: 581 × 6.8KB ≈ **3.9MB**
- 性能: ✅ 打开流畅，完全不卡

### 总结
- ✅ **10MB 以下**: Excel 打开秒开，编辑流畅
- ✅ **10-50MB**: 略有延迟，可接受
- ❌ **100MB+**: 明显卡顿

我们的预估都在 10MB 以下，完全不用担心性能问题。

---

## ⚙️ 推荐配置

### `.env` 文件配置

```bash
# 并发处理配置
MAX_WORKERS=5              # 推荐5，不要超过8
API_REQUEST_DELAY_MS=500   # 500ms 防止限流

# Excel 输出配置
MAX_TEXT_LABEL_LENGTH=30   # 短文本阈值
EXCEL_TABLE_GAP_ROWS=3     # 表格间隔行数
EXCEL_MAX_COLUMN_WIDTH=50  # 列宽上限
```

### 执行命令

```bash
# 顺序处理（测试用）
venv/bin/python scripts/process_images.py output/pdf_images

# 并行处理（实际使用）
venv/bin/python scripts/process_images_parallel.py output/pdf_images
```

---

## 📝 结论与建议

### 核心结论

1. **并发是关键**: 5.1倍加速，962页从11小时降至2.6小时
2. **API 速度波动**: 同样的数据耗时可能相差2倍，需要保守预估
3. **文件大小无忧**: 单页约7KB，千页也只有7MB，Excel 处理轻松

### 实施建议

1. **测试先行**: 先处理50-100页，验证实际速度
2. **分批处理**: 浙江和安徽分开处理，便于中断和检查
3. **错误重试**: 并行处理时个别失败可独立重试
4. **定时任务**: 晚上或周末运行，避免占用工作时间

### 风险提示

⚠️ **API 限流风险**: 虽然加了请求间隔，但大批量处理仍可能触发限流
✅ **缓解措施**: 
- 分批处理（每批 200-300 页）
- 批次间休息 10-15分钟
- 监控失败率，及时调整并发数

---

**最后更新**: 2026-01-24 07:55
