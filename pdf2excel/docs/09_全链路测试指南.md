# 全链路测试与处理指南 (Master Workflow)

本文根据过往开发记录，总结了从 PDF 处理到最终 Excel 校验的完整标准化流程。

## 1. 核心逻辑概述

目前项目采用 **"一省一策，智能分流"** 的架构：
*   **输入**：PDF 文件（需先拆分为图片）。
*   **中控**：`process_images_parallel.py`（或顺序版 `process_images.py`）。
*   **分流**：
    *   **浙江 (Zhejiang)**：使用标准 OCR + 在线 HTML 解析策略（`process_zhejiang.py`）。
    *   **安徽 (Anhui)**：使用双模型智能策略（`process_anhui.py`）：
        *   **表格页 (Page 01)**：自动检测网格 -> 走 PaddleOCR-VL (老接口) -> 保持表格完整。
        *   **文本页 (Page 05)**：自动检测文本 -> 走 StructureV3 (新接口) -> 保持段落顺序。

---

## 2. Standard Operation Procedure (SOP)

### 阶段一：数据准备 (Data Preparation)

**目标**：将 PDF 拆分为高清图片，并按目录归档。

1.  **准备文件**：将 PDF 文件放入方便的位置（如 `data/` 根目录）。
2.  **执行拆分**：使用工具箱中的 `pdf_to_images.py`。
    ```bash
    # 示例：拆分安徽 PDF
    python3 scripts/tools/anhui_physics.py data/anhui_physics.pdf --output-dir data/anhui_physics
    ```
    > **注意**：生成的图片默认为 `page_001.png`, `page_002.png` 格式。

---

### 阶段二：全量/批量处理 (Batch Processing)

**目标**：自动化运行 OCR 并生成 Excel。此阶段**无需人工介入**。

**关键脚本**：`scripts/process_images_parallel.py`

#### 场景 A：首次全量运行
```bash
# 浙江模式
python3 scripts/process_images_parallel.py data/zhejiang \
    --output-dir output/zhejiang \
    --province zhejiang

# 安徽模式
python3 scripts/process_images_parallel.py data/anhui_physics \
    --output-dir output/anhui_physics \
    --province anhui
```

#### 场景 B：中断后继续 (断点续传)
如果程序意外停止（断网、断电、手动 Ctrl+C），重新运行并加上 `--skip-existing`：
```bash
python3 scripts/process_images_parallel.py data/anhui_physics \
    --output-dir output/anhui_physics \
    --province anhui \
    --skip-existing
```

#### 场景 C：处理报错文件 (重试模式)
程序会自动生成 `failed_files.txt`。修复网络或配置后，仅重试失败项：
```bash
python3 scripts/process_images_parallel.py data/anhui_physics \
    --output-dir output/anhui_physics \
    --province anhui \
    --retry-failed
```

---

### 阶段三：人工校验与干预 (Verification & Intervention)

**目标**：检查生成的 Excel 是否符合预期。

**Checklist**:
1.  **文件数量对齐**：输入 100 张图，输出目录下是否有 100 个 `.xlsx`？
2.  **抽样检查**：
    *   **Page 01 (目录/表格)**：打开 Excel，检查表头是否完整，时间/人数列是否被拆散？
    *   **Page 05 (正文/文本)**：检查专业代码（3位数字）后的专业名称是否完整？多行备注是否正确合并？
3.  **异常处理**：
    *   **如果某页识别极差**：
        1.  单独拿出该图片。
        2.  使用 `scripts/process_images.py` (顺序版) 单独跑它，查看详细日志。
        3.  如果是图片模糊，尝试重新扫描或截图。
        4.  如果是逻辑问题，记录 Page 号反馈给开发调整正则。

---

## 3. 常见问题应对 (Troubleshooting)

| 现象                            | 可能原因   | 处理方案                                            |
| :------------------------------ | :--------- | :-------------------------------------------------- |
| **报错 `access_token invalid`** | Token 过期 | 更新 `.env` 中的 `AISTUDIO_TOKEN`                   |
| **报错 `QPS Limit Reached`**    | 并发太高   | 在 `.env` 中调小 `MAX_WORKERS` (如改到 3)           |
| **Excel 列宽异常 (#####)**      | 内容过长   | 浙江调整 `EXCEL_MAX_COLUMN_WIDTH`；安徽目前是固定宽 |
| **表格变成了纯文本**            | 模式误判   | 检查图片是否太模糊导致 OpenCV 没检测到表格线        |

---

## 4. 关键文件索引

*   **入口脚本**：
    *   `scripts/process_images_parallel.py` (推荐，生产用)
    *   `scripts/process_images.py` (调试用，单线程)
*   **工具箱**：
    *   `scripts/tools/pdf_to_images.py` (PDF拆图)
*   **核心逻辑**：
    *   `scripts/anhui/process_anhui.py` (安徽逻辑)
    *   `scripts/zhejiang/process_zhejiang.py` (浙江逻辑)
    *   `scripts/common/baidu_api_ocr.py` (通用 API 模块)
*   **配置**：
    *   `.env` (Token 和参数配置)
