# 环境配置与操作指南

## 一、 标准生产流程

### 1. 启动三部曲
```bash
# 1. 进入项目目录
cd /your/project/path

# 2. 激活虚拟环境
source venv/bin/activate

# 3. 运行脚本
python scripts/anhui/process_anhui.py <图片路径>
```

### 2. 身份验证说明
系统自动从 `.env` 读取 Token。严禁在代码中硬编码任何 API 密钥。

---

## 二、 CV2 (OpenCV) 专项排错

### 1. 根本原因分析
报错 `AttributeError: module 'cv2' has no attribute 'imread'` 通常由以下原因引起：
- **未激活 venv**（最常见）：系统 Python 环境不完整。
- **OpenCV 包冲突**：同时安装了 `opencv-python` 和 `opencv-contrib-python`。

### 2. 环境诊断脚本 (`diag.sh`)
```bash
#!/bin/bash
echo "=== CV2 环境深度诊断 ==="
echo -e "\n1. 检查虚拟环境:"
if [[ "$VIRTUAL_ENV" != "" ]]; then
    echo "✅ 已激活: $VIRTUAL_ENV"
else
    echo "❌ 未激活，请运行: source venv/bin/activate"
fi

echo -e "\n2. 检查 OpenCV 安装包:"
pip list | grep opencv

echo -e "\n3. 测试属性加载:"
python3 -c "import cv2; print(f'版本: {cv2.__version__}'); print('imread OK') if hasattr(cv2, 'imread') else print('❌ imread 缺失')"
```

---

## 三、 常用解析指令集

### 1. 处理单个文件
```bash
# 从图片生成 MD 和 Excel
python scripts/anhui/process_anhui.py data/sample.png --output-dir output/result

# 仅执行逻辑处理（从 MD 生成 Excel）
python scripts/anhui/process_anhui.py --md-input output/sample.md
```

### 2. 批量处理 (Shell 循环)
```bash
for page in 001 002 003 004 005 006; do
  python scripts/anhui/process_anhui.py --md-input output/anhui_history/page_${page}_*.md --output-dir output/anhui_history/FINAL
done
```

---

## 四、 自动化配置

### 1. 终端别名
在 `~/.zshrc` 中添加：
```bash
alias pdf2excel='cd /your/project/path && source venv/bin/activate'
```

### 2. 脚本内强校验
```python
import sys
if not hasattr(sys, 'real_prefix') and not (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix):
    print("❌ 错误: 请先执行 source venv/bin/activate")
    sys.exit(1)
```

---

**版本**: v1.9 (2026-01-24)  
**红线**: 所有生产操作必须在 `(venv)` 前缀下进行。
