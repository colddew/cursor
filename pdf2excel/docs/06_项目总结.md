# PDF/图片表格提取项目总结

## 📸 测试图片分析

### 浙江招生大本样例（zhejiang.png）

**内容结构**：
- 标题："2025年高考招生志愿填报须知"
- 3段说明文字
- 1个时间表格（2列：日期 + 内容）
- 1行注释

![浙江招生须知](file:///project_root/zhejiang.png)

**表格特点**：
- 单元格内有多行文本
- 日期格式较复杂
- 文字和表格紧密混排

---

## ✅ 已实现的方案

### 1. Apple Vision Framework OCR

**文件**：[vision_ocr.py](file:///project_root/vision_ocr.py)

**测试结果**：
- ⏱️ 处理时间：2.6秒
- 📝 识别文本块：27个
- ✅ 文字识别准确
- ❌ 表格结构丢失（被拆成独立文本）

**适用场景**：快速文本提取，非表格型文档

---

### 2. 百度通用 OCR API

**文件**：[baidu_ocr.py](file:///project_root/baidu_ocr.py)

**特点**：
- 在线识别，需要 API Key
- 速度快，准确率高
- 免费额度：1000次/天
- ❌ 表格结构仍需手动整理

---

### 3. 百度表格识别 API ⭐ 推荐

**文件**：[baidu_table_ocr.py](file:///project_root/baidu_table_ocr.py)

**优势**：
- ✅ **自动识别表格结构**
- ✅ 保留单元格行列关系
- ✅ 直接输出 Excel 格式
- ✅ 处理文字表格混排

**免费额度**：50次/天

**使用方法**：
```bash
export BAIDU_OCR_API_KEY='your_key'
export BAIDU_OCR_SECRET_KEY='your_secret'
./venv/bin/python baidu_table_ocr.py zhejiang.png
```

---

## 🎯 针对招生大本的建议

### 最佳方案：百度表格识别 API

**原因**：
1. 招生大本典型特征：文字 + 表格混排
2. 表格单元格包含多行文本
3. 需要保留完整的表格结构
4. 50次/天免费额度通常够用

### 使用流程：

1. **准备图片**：
   - 拍照或扫描，保存为 PNG/JPG
   - 分辨率建议 300 DPI 以上
   - 确保光线均匀，文字清晰

2. **获取 API Key**：
   - 访问 https://ai.baidu.com/
   - 创建应用，选择【表格文字识别】
   - 获取并设置环境变量

3. **批量处理**：
   ```bash
   # 处理单页
   ./venv/bin/python baidu_table_ocr.py page1.png
   
   # 处理多页（写个循环脚本）
   for file in *.png; do
       ./venv/bin/python baidu_table_ocr.py "$file"
   done
   ```

---

## 📊 性能对比总结

| 方案       | 速度  | 准确率 | 表格结构 | 成本     | 推荐度 |
| ---------- | ----- | ------ | -------- | -------- | ------ |
| Vision OCR | ⚡⚡⚡⚡⚡ | ⭐⭐⭐⭐   | ❌        | 免费     | ⭐⭐⭐    |
| 百度通用   | ⚡⚡⚡⚡  | ⭐⭐⭐⭐⭐  | ❌        | 免费额度 | ⭐⭐⭐    |
| 百度表格   | ⚡⚡⚡   | ⭐⭐⭐⭐⭐  | ✅        | 免费额度 | ⭐⭐⭐⭐⭐  |

---

## 🚀 快速开始

### Vision OCR（本地最快）
```bash
./venv/bin/python vision_ocr.py zhejiang.png
```

### 百度表格识别（最准确）
```bash
# 设置 API Key（首次）
export BAIDU_OCR_API_KEY='your_key'
export BAIDU_OCR_SECRET_KEY='your_secret'

# 运行
./venv/bin/python baidu_table_ocr.py zhejiang.png
```

---

## 📁 项目文件说明

### OCR 脚本
- `vision_ocr.py` - Apple Vision Framework（本地，快速）
- `baidu_ocr.py` - 百度通用 OCR API
- `baidu_table_ocr.py` - 百度表格识别 API（推荐）

### 辅助工具
- `run_ocr.sh` - 统一运行脚本
- `analyze_pdf.py` - PDF 结构分析工具

### 文档
- `README.md` - 快速开始指南
- 完整使用指南（artifact）

---

## ✨ 关键结论

1. **图片 vs PDF**：对 OCR 来说基本相同，**图片处理更简单**

2. **2015 Intel MacBook**：
   - Vision Framework 完全支持，速度很快
   - 无需担心 M 系列芯片兼容性

3. **表格识别**：
   - 通用 OCR 无法保留表格结构
   - **必须使用专门的表格识别 API**
   - 百度表格识别效果最好

4. **速度问题**：
   - PaddleOCR 太慢（3-5分钟/页）
   - Vision OCR 很快（2-3秒/页）
   - 百度 API 速度适中（3-5秒/页）

5. **成本考虑**：
   - 百度免费额度（50次/天）足够日常使用
   - 超出后仅 0.03元/次，成本很低

---

## 🎨 Excel 输出优化（2026-01-21）

### 背景与动机

PaddleOCR-VL API 返回的是 HTML 格式的表格，初始方案是每个 `<table>` 标签创建一个 Sheet，导致：
1. **页面碎片化**: 一页可能有多个 Sheet，不直观
2. **文本标识丢失**: 表格间的地区标签（如 `[浙江]`、`[北京]`）被忽略
3. **无视觉分隔**: 连续表格紧挨着，容易被误合并

### 核心决策：单 Sheet 模式

**选择**: 一页 = 一个 Excel 文件 = 一个 Sheet "识别结果"

**理由**:
- 保持页面完整性，便于预览和校对
- 简化后续合并处理逻辑
- 符合用户心智模型（一页对应一个文件）

### 关键技术难点

#### 1. 连续表格识别
**问题**: 两个 `<table>` 中间只有空白时，如何判断是否需要空行？

**错误尝试**:
```python
# 方案1：遇到非表格就重置标记 ❌
# 会导致空白文本也重置，连续表格失效
for element in soup.contents:
    if element.name == 'table':
        # 处理表格
    else:
        last_was_table = False  # 空白也会重置！
```

**正确方案**: 只有有效文本才重置
```python
else:
    text = element.get_text(strip=True)
    if len(text) > 0:  # 只有非空文本才重置
        last_was_table = False
```

#### 2. 中文列宽计算
**问题**: 直接用字符数，中文内容会被截断

**错误方案**: `len("中国") = 2` → 列宽2 ❌（太窄）

**正确方案**: 中文字符算2，ASCII算1
```python
display_width = sum(2 if ord(c) > 127 else 1 for c in text)
# "中国" → 4（合适）
# "China" → 5（合适）
```

#### 3. 表头自动换行
**问题**: 表头明明能单行显示，却自动换成两行

**原因**: `wrap_text=True` 对所有单元格生效

**解决**: 表头禁用自动换行
```python
is_header = (cell.name == 'th' or r_idx_in_table == 1)
alignment = Alignment(
    wrap_text=(not is_header),  # 表头不换行
    vertical='top', 
    horizontal='center'
)
```

### 配置化设计

通过环境变量实现灵活配置：

| 配置项                   | 默认值 | 说明                     |
| ------------------------ | ------ | ------------------------ |
| `MAX_TEXT_LABEL_LENGTH`  | 30     | 短文本阈值，0-30字符保留 |
| `EXCEL_TABLE_GAP_ROWS`   | 3      | 连续表格间隔行数         |
| `EXCEL_MAX_COLUMN_WIDTH` | 50     | 列宽上限（字符）         |
| `API_REQUEST_DELAY_MS`   | 1000   | 并发请求间隔（毫秒）     |

### 最终效果

✅ **单 Sheet 完整性**: 一页一文件一 Sheet，结构清晰  
✅ **文本标识保留**: `[北京]` 等标签作为加粗居中标题行插入  
✅ **表格视觉分隔**: 自动空行，防止误合并  
✅ **列宽自适应**: 中文正确显示，长内容自动折叠  
✅ **表头简洁**: 单行显示，不换行

### 参考文档

- 性能测试: [07_性能测试报告](./07_性能测试报告.md)
- 实现计划: artifact `implementation_plan.md`
